{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/suggestions/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { PrismaClient } from \"@prisma/client\"\nimport { randomUUID } from \"crypto\"\nimport jwt from \"jsonwebtoken\"\n\nconst prisma = new PrismaClient()\n\nasync function ensureTable() {\n  await prisma.$executeRawUnsafe(`\n    CREATE TABLE IF NOT EXISTS suggestions (\n      id TEXT PRIMARY KEY,\n      name TEXT,\n      email TEXT,\n      type TEXT,\n      message TEXT,\n      admin_response TEXT,\n      responder_name TEXT,\n      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),\n      responded_at TIMESTAMP WITH TIME ZONE\n    )\n  `)\n}\n\nfunction getTokenFromHeaders(req: Request) {\n  const cookie = req.headers.get('cookie') || ''\n  const match = cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith('token='))\n  if (!match) return null\n  return match.split('=')[1]\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json()\n    const { name, email, type, message } = body || {}\n    const errors: Record<string,string> = {}\n    if (!email) errors.email = 'Email is required'\n    if (!message) errors.message = 'Message is required'\n    if (Object.keys(errors).length) return NextResponse.json({ errors }, { status: 400 })\n\n    await ensureTable()\n    const id = randomUUID()\n    await prisma.$executeRawUnsafe(`INSERT INTO suggestions (id, name, email, type, message, created_at) VALUES ($1,$2,$3,$4,$5,NOW())`, id, name ? String(name) : null, String(email), type ? String(type) : 'suggestion', String(message))\n    return NextResponse.json({ suggestion: { id, name, email, type, message } }, { status: 201 })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n\nexport async function GET(req: Request) {\n  try {\n    // Allow users to fetch their own suggestions by email (no auth required for convenience)\n    const url = new URL(req.url)\n    const email = url.searchParams.get('email')\n\n    await ensureTable()\n    if (email) {\n      const rows: any[] = await prisma.$queryRawUnsafe(`SELECT id, name, email, type, message, admin_response as \"adminResponse\", responder_name as \"responderName\", created_at as \"createdAt\", responded_at as \"respondedAt\" FROM suggestions WHERE LOWER(email) = LOWER($1) ORDER BY created_at DESC`, String(email))\n      return NextResponse.json({ suggestions: rows })\n    }\n\n    // admin list all\n    // try to obtain token from cookie or Authorization header\n    let token: string | null = getTokenFromHeaders(req)\n    if (!token) {\n      const authHeader = req.headers.get('authorization') || req.headers.get('Authorization')\n      if (authHeader && authHeader.toLowerCase().startsWith('bearer ')) token = authHeader.split(' ')[1]\n    }\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    let payload: any = null\n    try { payload = jwt.verify(token, secret) } catch (e) { return NextResponse.json({ error: 'Unauthorized' }, { status: 401 }) }\n    // allow either admin role OR a configured admin email as a fallback\n    const adminEmailFallback = process.env.ADMIN_EMAIL || ''\n    if (payload.role !== 'admin' && String(payload.email || '').toLowerCase() !== adminEmailFallback.toLowerCase()) {\n      return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\n    }\n\n    const rows: any[] = await prisma.$queryRawUnsafe(`SELECT id, name, email, type, message, admin_response as \"adminResponse\", responder_name as \"responderName\", created_at as \"createdAt\", responded_at as \"respondedAt\" FROM suggestions ORDER BY created_at DESC`)\n    return NextResponse.json({ suggestions: rows })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n\nexport async function PATCH(req: Request) {\n  try {\n    // try to obtain token from cookie or Authorization header\n    let token: string | null = getTokenFromHeaders(req)\n    if (!token) {\n      const authHeader = req.headers.get('authorization') || req.headers.get('Authorization')\n      if (authHeader && authHeader.toLowerCase().startsWith('bearer ')) token = authHeader.split(' ')[1]\n    }\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    let payload: any = null\n    try { payload = jwt.verify(token, secret) } catch (e) { return NextResponse.json({ error: 'Unauthorized' }, { status: 401 }) }\n    const adminEmailFallback = process.env.ADMIN_EMAIL || ''\n    if (payload.role !== 'admin' && String(payload.email || '').toLowerCase() !== adminEmailFallback.toLowerCase()) return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\n\n    const body = await req.json()\n    const { id, response, responderName } = body || {}\n    if (!id || !response) return NextResponse.json({ error: 'Missing id or response' }, { status: 400 })\n\n    await ensureTable()\n    const responder = responderName || payload.email || payload.name || 'admin'\n    await prisma.$executeRawUnsafe(`UPDATE suggestions SET admin_response = $1, responder_name = $3, responded_at = NOW() WHERE id = $2`, String(response), id, String(responder))\n    return NextResponse.json({ ok: true })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}