{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/auth/password-reset/confirm/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { PrismaClient } from \"@prisma/client\"\nimport bcrypt from \"bcryptjs\"\n\nconst prisma = new PrismaClient()\n\nasync function ensureTable() {\n  await prisma.$executeRawUnsafe(`\n    CREATE TABLE IF NOT EXISTS password_reset_tokens (\n      id TEXT PRIMARY KEY,\n      user_id TEXT NOT NULL,\n      token TEXT NOT NULL,\n      expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n      used BOOLEAN DEFAULT false,\n      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),\n      used_at TIMESTAMP WITH TIME ZONE\n    )\n  `)\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json()\n    const { token, password } = body || {}\n    if (!token || !password) return NextResponse.json({ error: 'Token and password required' }, { status: 400 })\n\n    await ensureTable()\n    const rows: any[] = await prisma.$queryRaw`SELECT id, user_id, token, expires_at, used FROM password_reset_tokens WHERE token = ${String(token)} LIMIT 1`\n    const row = rows && rows.length ? rows[0] : null\n    if (!row) return NextResponse.json({ error: 'Invalid or expired token' }, { status: 400 })\n    if (row.used) return NextResponse.json({ error: 'Token already used' }, { status: 400 })\n    if (new Date(row.expires_at) < new Date()) return NextResponse.json({ error: 'Token expired' }, { status: 400 })\n\n    const hash = await bcrypt.hash(String(password), 12)\n    await prisma.$executeRaw`UPDATE \"User\" SET password = ${hash} WHERE id = ${row.user_id}`\n    await prisma.$executeRaw`UPDATE password_reset_tokens SET used = true, used_at = NOW() WHERE id = ${row.id}`\n\n    return NextResponse.json({ ok: true })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAE/B,eAAe;IACb,MAAM,OAAO,iBAAiB,CAAC,CAAC;;;;;;;;;;EAUhC,CAAC;AACH;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,QAAQ,CAAC;QACrC,IAAI,CAAC,SAAS,CAAC,UAAU,OAAO,uRAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA8B,GAAG;YAAE,QAAQ;QAAI;QAE1G,MAAM;QACN,MAAM,OAAc,MAAM,OAAO,SAAS,CAAC,qFAAqF,EAAE,OAAO,OAAO,QAAQ,CAAC;QACzJ,MAAM,MAAM,QAAQ,KAAK,MAAM,GAAG,IAAI,CAAC,EAAE,GAAG;QAC5C,IAAI,CAAC,KAAK,OAAO,uRAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA2B,GAAG;YAAE,QAAQ;QAAI;QACxF,IAAI,IAAI,IAAI,EAAE,OAAO,uRAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAqB,GAAG;YAAE,QAAQ;QAAI;QACtF,IAAI,IAAI,KAAK,IAAI,UAAU,IAAI,IAAI,QAAQ,OAAO,uRAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAgB,GAAG;YAAE,QAAQ;QAAI;QAE9G,MAAM,OAAO,MAAM,2MAAM,CAAC,IAAI,CAAC,OAAO,WAAW;QACjD,MAAM,OAAO,WAAW,CAAC,6BAA6B,EAAE,KAAK,YAAY,EAAE,IAAI,OAAO,CAAC,CAAC;QACxF,MAAM,OAAO,WAAW,CAAC,yEAAyE,EAAE,IAAI,EAAE,CAAC,CAAC;QAE5G,OAAO,uRAAY,CAAC,IAAI,CAAC;YAAE,IAAI;QAAK;IACtC,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC;QACd,OAAO,uRAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF","debugId":null}}]
}