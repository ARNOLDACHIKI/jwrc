{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = global as unknown as { __prisma?: PrismaClient }\n\nconst prisma = globalForPrisma.__prisma ?? new PrismaClient()\nif (process.env.NODE_ENV !== 'production') globalForPrisma.__prisma = prisma\n\nexport async function safeExecute(sql: string, ...params: any[]) {\n  try {\n    return await prisma.$executeRawUnsafe(sql, ...params)\n  } catch (err: any) {\n    console.warn('DB execute failed:', err?.message || err)\n    return null\n  }\n}\n\nexport async function safeQuery<T = any>(sql: string, ...params: any[]): Promise<T[]> {\n  try {\n    const rows = await prisma.$queryRawUnsafe(sql, ...params)\n    return Array.isArray(rows) ? (rows as T[]) : (rows ? [rows as T] : [])\n  } catch (err: any) {\n    console.warn('DB query failed:', err?.message || err)\n    return []\n  }\n}\n\nexport { prisma }\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM;AAEN,MAAM,SAAS,gBAAgB,QAAQ,IAAI,IAAI,6IAAY;AAC3D,wCAA2C,gBAAgB,QAAQ,GAAG;AAE/D,eAAe,YAAY,GAAW,EAAE,GAAG,MAAa;IAC7D,IAAI;QACF,OAAO,MAAM,OAAO,iBAAiB,CAAC,QAAQ;IAChD,EAAE,OAAO,KAAU;QACjB,QAAQ,IAAI,CAAC,sBAAsB,KAAK,WAAW;QACnD,OAAO;IACT;AACF;AAEO,eAAe,UAAmB,GAAW,EAAE,GAAG,MAAa;IACpE,IAAI;QACF,MAAM,OAAO,MAAM,OAAO,eAAe,CAAC,QAAQ;QAClD,OAAO,MAAM,OAAO,CAAC,QAAS,OAAgB,OAAO;YAAC;SAAU,GAAG,EAAE;IACvE,EAAE,OAAO,KAAU;QACjB,QAAQ,IAAI,CAAC,oBAAoB,KAAK,WAAW;QACjD,OAAO,EAAE;IACX;AACF","debugId":null}},
    {"offset": {"line": 95, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/auth/password-reset/request/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { prisma, safeExecute } from '@/lib/db'\nimport { randomBytes } from \"crypto\"\nimport bcrypt from \"bcryptjs\"\n\n \n\nasync function ensureTable() {\n  await safeExecute(`\n    CREATE TABLE IF NOT EXISTS password_reset_tokens (\n      id TEXT PRIMARY KEY,\n      user_id TEXT NOT NULL,\n      token TEXT NOT NULL,\n      expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n      used BOOLEAN DEFAULT false,\n      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),\n      used_at TIMESTAMP WITH TIME ZONE\n    )\n  `)\n  await safeExecute(`CREATE INDEX IF NOT EXISTS password_reset_tokens_token_idx ON password_reset_tokens(token)`)\n}\n\nasync function findUserByEmail(email: string) {\n  // try exact then case-insensitive\n  let user = await prisma.user.findUnique({ where: { email } })\n  if (!user) {\n    try {\n      user = await prisma.user.findFirst({ where: { email: { equals: email, mode: 'insensitive' } } })\n    } catch (e) {\n      // ignore\n    }\n  }\n  return user\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json()\n    const { email } = body || {}\n    if (!email) return NextResponse.json({ error: 'Email required' }, { status: 400 })\n\n    const user = await findUserByEmail(String(email))\n    // do not reveal whether user exists\n    await ensureTable()\n    if (!user) return NextResponse.json({ ok: true })\n\n    const token = randomBytes(24).toString('hex')\n    const id = randomBytes(12).toString('hex')\n    const expiresAt = new Date(Date.now() + 1000 * 60 * 60) // 1 hour\n\n    await safeExecute(`INSERT INTO password_reset_tokens (id, user_id, token, expires_at, used, created_at) VALUES ($1,$2,$3,$4,false,NOW())`, id, user.id, token, expiresAt)\n\n    // try to send email if SMTP configured\n    let emailSent = false\n    try {\n      if (process.env.SMTP_HOST && process.env.SMTP_USER) {\n        const nodemailer = await import('nodemailer')\n        const transporter = nodemailer.createTransport({\n          host: process.env.SMTP_HOST,\n          port: Number(process.env.SMTP_PORT || 587),\n          secure: (process.env.SMTP_SECURE === 'true'),\n          auth: { user: process.env.SMTP_USER, pass: process.env.SMTP_PASS }\n        })\n        const site = process.env.SITE_URL || 'http://localhost:3000'\n        const resetLink = `${site}/reset-password?token=${token}`\n        await transporter.sendMail({\n          from: process.env.SMTP_FROM || process.env.SMTP_USER,\n          to: user.email,\n          subject: 'Password reset request',\n          text: `You requested a password reset. Use this link to reset your password: ${resetLink} (expires in 1 hour)`\n        })\n        emailSent = true\n        console.log('Password reset email sent to:', user.email)\n      }\n    } catch (e) {\n      console.warn('Failed to send password reset email', e)\n    }\n\n    // In development, always return token for manual testing (useful for testing the reset flow)\n    const isDev = (process.env.NODE_ENV || 'development') === 'development'\n    if (isDev) {\n      return NextResponse.json({ ok: true, token, emailSent })\n    }\n\n    // In production, only return token if email send failed (for debugging)\n    if (!emailSent) {\n      return NextResponse.json({ ok: true, token })\n    }\n\n    return NextResponse.json({ ok: true })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAKA,eAAe;IACb,MAAM,IAAA,0HAAW,EAAC,CAAC;;;;;;;;;;EAUnB,CAAC;IACD,MAAM,IAAA,0HAAW,EAAC,CAAC,0FAA0F,CAAC;AAChH;AAEA,eAAe,gBAAgB,KAAa;IAC1C,kCAAkC;IAClC,IAAI,OAAO,MAAM,qHAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QAAE,OAAO;YAAE;QAAM;IAAE;IAC3D,IAAI,CAAC,MAAM;QACT,IAAI;YACF,OAAO,MAAM,qHAAM,CAAC,IAAI,CAAC,SAAS,CAAC;gBAAE,OAAO;oBAAE,OAAO;wBAAE,QAAQ;wBAAO,MAAM;oBAAc;gBAAE;YAAE;QAChG,EAAE,OAAO,GAAG;QACV,SAAS;QACX;IACF;IACA,OAAO;AACT;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,KAAK,EAAE,GAAG,QAAQ,CAAC;QAC3B,IAAI,CAAC,OAAO,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;QAEhF,MAAM,OAAO,MAAM,gBAAgB,OAAO;QAC1C,oCAAoC;QACpC,MAAM;QACN,IAAI,CAAC,MAAM,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,IAAI;QAAK;QAE/C,MAAM,QAAQ,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;QACvC,MAAM,KAAK,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;QACpC,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,OAAO,KAAK,IAAI,SAAS;;QAEjE,MAAM,IAAA,0HAAW,EAAC,CAAC,qHAAqH,CAAC,EAAE,IAAI,KAAK,EAAE,EAAE,OAAO;QAE/J,uCAAuC;QACvC,IAAI,YAAY;QAChB,IAAI;YACF,IAAI,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,SAAS,EAAE;gBAClD,MAAM,aAAa;gBACnB,MAAM,cAAc,WAAW,eAAe,CAAC;oBAC7C,MAAM,QAAQ,GAAG,CAAC,SAAS;oBAC3B,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;oBACtC,QAAS,QAAQ,GAAG,CAAC,WAAW,KAAK;oBACrC,MAAM;wBAAE,MAAM,QAAQ,GAAG,CAAC,SAAS;wBAAE,MAAM,QAAQ,GAAG,CAAC,SAAS;oBAAC;gBACnE;gBACA,MAAM,OAAO,QAAQ,GAAG,CAAC,QAAQ,IAAI;gBACrC,MAAM,YAAY,GAAG,KAAK,sBAAsB,EAAE,OAAO;gBACzD,MAAM,YAAY,QAAQ,CAAC;oBACzB,MAAM,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,SAAS;oBACpD,IAAI,KAAK,KAAK;oBACd,SAAS;oBACT,MAAM,CAAC,sEAAsE,EAAE,UAAU,oBAAoB,CAAC;gBAChH;gBACA,YAAY;gBACZ,QAAQ,GAAG,CAAC,iCAAiC,KAAK,KAAK;YACzD;QACF,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,uCAAuC;QACtD;QAEA,6FAA6F;QAC7F,MAAM,QAAQ,CAAC,mDAAwB,aAAa,MAAM;QAC1D,wCAAW;YACT,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAM;gBAAO;YAAU;QACxD;;;IAQF,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC;QACd,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF","debugId":null}}]
}