{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/events/signups/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { PrismaClient } from \"@prisma/client\"\nimport jwt from \"jsonwebtoken\"\nimport { randomUUID } from \"crypto\"\n\nconst prisma = new PrismaClient()\n\nfunction getTokenFromHeaders(req: Request) {\n  const cookie = req.headers.get(\"cookie\") || \"\"\n  const match = cookie.split(\";\").map((c) => c.trim()).find((c) => c.startsWith(\"token=\"))\n  if (!match) return null\n  return match.split(\"=\")[1]\n}\n\nasync function ensureTable() {\n  // create a simple signups table if it doesn't exist\n  await prisma.$executeRawUnsafe(`\n    CREATE TABLE IF NOT EXISTS event_signups (\n      id TEXT PRIMARY KEY,\n      event_id TEXT NOT NULL,\n      ref TEXT UNIQUE,\n      name TEXT NOT NULL,\n      email TEXT NOT NULL,\n      phone TEXT,\n      created_at TIMESTAMP WITH TIME ZONE DEFAULT now()\n    )\n  `)\n  // ensure ref column exists (if table pre-existed without it)\n  await prisma.$executeRawUnsafe(`ALTER TABLE event_signups ADD COLUMN IF NOT EXISTS ref TEXT`) \n  await prisma.$executeRawUnsafe(`CREATE UNIQUE INDEX IF NOT EXISTS event_signups_ref_idx ON event_signups(ref)`) \n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json()\n    const { eventId, name, email, phone } = body || {}\n    const errors: Record<string, string> = {}\n    if (!eventId) errors.eventId = 'Event id is required'\n    if (!name || String(name).trim().length === 0) errors.name = 'Name is required'\n    if (!email || String(email).trim().length === 0) errors.email = 'Email is required'\n    if (Object.keys(errors).length > 0) return NextResponse.json({ errors }, { status: 400 })\n\n    // ensure event exists\n    const ev = await prisma.event.findUnique({ where: { id: eventId } })\n    if (!ev) return NextResponse.json({ error: 'Event not found' }, { status: 404 })\n\n    await ensureTable()\n\n    await ensureTable()\n\n    // dedupe: prevent same email signing up multiple times for same event\n    const exists: any[] = await prisma.$queryRawUnsafe(`SELECT id FROM event_signups WHERE event_id = $1 AND lower(email) = lower($2) LIMIT 1`, eventId, String(email))\n    if (exists && exists.length > 0) {\n      return NextResponse.json({ error: 'Already signed up' }, { status: 409 })\n    }\n\n    // generate a short human-friendly ref\n    function genRef() {\n      return (Date.now()).toString(36) + Math.random().toString(36).slice(2,6)\n    }\n\n    let ref = genRef()\n    // ensure unique ref\n    for (let i = 0; i < 5; i++) {\n      const r: any = await prisma.$queryRawUnsafe(`SELECT id FROM event_signups WHERE ref = $1 LIMIT 1`, ref)\n      if (!Array.isArray(r) || r.length === 0) break\n      ref = genRef()\n    }\n\n    const id = randomUUID()\n    await prisma.$executeRawUnsafe(\n      `INSERT INTO event_signups (id, event_id, ref, name, email, phone, created_at) VALUES ($1,$2,$3,$4,$5,$6,NOW())`,\n      id,\n      eventId,\n      ref,\n      String(name),\n      String(email),\n      phone ? String(phone) : null\n    )\n\n    // try send confirmation email if SMTP env provided (optional)\n    try {\n      if (process.env.SMTP_HOST && process.env.SMTP_USER) {\n        try {\n          const nodemailer = await import('nodemailer')\n          const transporter = nodemailer.createTransport({\n            host: process.env.SMTP_HOST,\n            port: Number(process.env.SMTP_PORT || 587),\n            secure: (process.env.SMTP_SECURE === 'true'),\n            auth: { user: process.env.SMTP_USER, pass: process.env.SMTP_PASS },\n          })\n          await transporter.sendMail({\n            from: process.env.SMTP_FROM || process.env.SMTP_USER,\n            to: String(email),\n            subject: `Signup confirmation for ${ev.title}`,\n            text: `Thanks ${name},\\n\\nYou have been registered as interested in ${ev.title} on ${ev.startsAt}.\\n\\n- ${process.env.SITE_NAME || 'Site'}`,\n          })\n        } catch (e) {\n          console.warn('Failed to send confirmation email', e)\n        }\n      }\n    } catch (e) {\n      console.warn('Email send skipped', e)\n    }\n\n    return NextResponse.json({ signup: { id, ref, eventId, name, email, phone } }, { status: 201 })\n  } catch (err) {\n    console.error(err)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n\nexport async function DELETE(req: Request) {\n  try {\n    // admin-only\n    const token = getTokenFromHeaders(req)\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    let payload: any = null\n    try { payload = jwt.verify(token, secret) } catch (e) { return NextResponse.json({ error: 'Unauthorized' }, { status: 401 }) }\n    if (payload.role !== 'admin') return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\n\n    const body = await req.json()\n    const { id } = body || {}\n    if (!id) return NextResponse.json({ error: 'Missing id' }, { status: 400 })\n\n    await ensureTable()\n    try {\n      await prisma.$executeRawUnsafe(`DELETE FROM event_signups WHERE id = $1`, id)\n      return NextResponse.json({ ok: true })\n    } catch (e) {\n      console.error(e)\n      return NextResponse.json({ error: 'Failed to delete' }, { status: 500 })\n    }\n  } catch (err) {\n    console.error(err)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n\nexport async function GET(req: Request) {\n  try {\n    // admin-only: requires token cookie\n    const token = getTokenFromHeaders(req)\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    let payload: any = null\n    try {\n      payload = jwt.verify(token, secret)\n    } catch (e) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n    if (payload.role !== 'admin') return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\n\n    const url = new URL(req.url)\n    const eventId = url.searchParams.get('eventId')\n    if (!eventId) return NextResponse.json({ error: 'Missing eventId' }, { status: 400 })\n\n    await ensureTable()\n\n    const rows: any[] = await prisma.$queryRawUnsafe(`SELECT id, ref, event_id as eventId, name, email, phone, created_at as \"createdAt\" FROM event_signups WHERE event_id = $1 ORDER BY created_at DESC`, eventId)\n\n    return NextResponse.json({ signups: rows })\n  } catch (err) {\n    console.error(err)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}