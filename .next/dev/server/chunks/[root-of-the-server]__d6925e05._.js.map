{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/user/inbox/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { PrismaClient } from '@prisma/client'\nimport jwt from 'jsonwebtoken'\n\nconst prisma = new PrismaClient()\n\nfunction getTokenFromHeaders(req: Request) {\n  const cookie = req.headers.get('cookie') || ''\n  const match = cookie.split(';').map(c => c.trim()).find(c => c.startsWith('token='))\n  if (!match) return null\n  return match.split('=')[1]\n}\n\nasync function ensureTable() {\n  await prisma.$executeRawUnsafe(`\n    CREATE TABLE IF NOT EXISTS inbox_seen (\n      user_id TEXT PRIMARY KEY,\n      last_seen TIMESTAMP WITH TIME ZONE\n    )\n  `)\n}\n\nexport const dynamic = 'force-dynamic'\n\n\nexport async function GET(req: Request) {\n  try {\n    const token = getTokenFromHeaders(req)\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ lastSeen: null, unreadCount: 0 })\n    let payload: any = null\n    try { payload = jwt.verify(token, secret) } catch (e) { return NextResponse.json({ lastSeen: null, unreadCount: 0 }) }\n    const userId = payload.userId\n    const email = payload.email\n\n    await ensureTable()\n    const row: any[] = await prisma.$queryRawUnsafe(`SELECT last_seen FROM inbox_seen WHERE user_id = $1`, String(userId))\n    const lastSeen = row && row.length > 0 ? row[0].last_seen : null\n\n    // compute unread from suggestions and volunteer_applications\n    let unread = 0\n    if (lastSeen) {\n      try {\n        // Convert timestamp to ISO format for PostgreSQL\n        const lastSeenISO = lastSeen instanceof Date ? lastSeen.toISOString() : new Date(lastSeen).toISOString()\n        const s: any[] = await prisma.$queryRawUnsafe(`SELECT COUNT(*) as c FROM suggestions WHERE LOWER(email)=LOWER($1) AND ((responded_at IS NOT NULL AND responded_at > $2::timestamptz) OR (responded_at IS NULL AND created_at > $2::timestamptz))`, String(email), lastSeenISO)\n        const v: any[] = await prisma.$queryRawUnsafe(`SELECT COUNT(*) as c FROM volunteer_applications WHERE LOWER(email)=LOWER($1) AND ((responded_at IS NOT NULL AND responded_at > $2::timestamptz) OR (responded_at IS NULL AND created_at > $2::timestamptz))`, String(email), lastSeenISO)\n        unread = (s[0]?.c || 0) + (v[0]?.c || 0)\n      } catch (e) {\n        console.error(\"Error counting unread:\", e)\n        unread = 0\n      }\n    } else {\n      try {\n        // if never seen, count items that have admin responses/messages\n        const s: any[] = await prisma.$queryRawUnsafe(`SELECT COUNT(*) as c FROM suggestions WHERE LOWER(email)=LOWER($1) AND admin_response IS NOT NULL`, String(email))\n        const v: any[] = await prisma.$queryRawUnsafe(`SELECT COUNT(*) as c FROM volunteer_applications WHERE LOWER(email)=LOWER($1) AND admin_message IS NOT NULL`, String(email))\n        unread = (s[0]?.c || 0) + (v[0]?.c || 0)\n      } catch (e) {\n        console.error(\"Error counting new unread:\", e)\n        unread = 0\n      }\n    }\n\n    return NextResponse.json({ lastSeen: lastSeen || null, unreadCount: Number(unread) })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ lastSeen: null, unreadCount: 0 })\n  }\n}\n\nexport async function PATCH(req: Request) {\n  try {\n    const token = getTokenFromHeaders(req)\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    let payload: any = null\n    try { payload = jwt.verify(token, secret) } catch (e) { return NextResponse.json({ error: 'Unauthorized' }, { status: 401 }) }\n    const userId = payload.userId\n\n    await ensureTable()\n    // set last_seen to now\n    await prisma.$executeRawUnsafe(`INSERT INTO inbox_seen (user_id, last_seen) VALUES ($1, NOW()) ON CONFLICT (user_id) DO UPDATE SET last_seen = NOW()`, String(userId))\n    return NextResponse.json({ ok: true })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}