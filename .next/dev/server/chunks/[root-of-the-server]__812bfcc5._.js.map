{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = global as unknown as { __prisma?: PrismaClient }\n\nconst prisma = globalForPrisma.__prisma ?? new PrismaClient()\nif (process.env.NODE_ENV !== 'production') globalForPrisma.__prisma = prisma\n\nexport async function safeExecute(sql: string, ...params: any[]) {\n  try {\n    return await prisma.$executeRawUnsafe(sql, ...params)\n  } catch (err: any) {\n    console.warn('DB execute failed:', err?.message || err)\n    return null\n  }\n}\n\nexport async function safeQuery<T = any>(sql: string, ...params: any[]): Promise<T[]> {\n  try {\n    const rows = await prisma.$queryRawUnsafe(sql, ...params)\n    return Array.isArray(rows) ? (rows as T[]) : (rows ? [rows as T] : [])\n  } catch (err: any) {\n    console.warn('DB query failed:', err?.message || err)\n    return []\n  }\n}\n\nexport { prisma }\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM;AAEN,MAAM,SAAS,gBAAgB,QAAQ,IAAI,IAAI,6IAAY;AAC3D,wCAA2C,gBAAgB,QAAQ,GAAG;AAE/D,eAAe,YAAY,GAAW,EAAE,GAAG,MAAa;IAC7D,IAAI;QACF,OAAO,MAAM,OAAO,iBAAiB,CAAC,QAAQ;IAChD,EAAE,OAAO,KAAU;QACjB,QAAQ,IAAI,CAAC,sBAAsB,KAAK,WAAW;QACnD,OAAO;IACT;AACF;AAEO,eAAe,UAAmB,GAAW,EAAE,GAAG,MAAa;IACpE,IAAI;QACF,MAAM,OAAO,MAAM,OAAO,eAAe,CAAC,QAAQ;QAClD,OAAO,MAAM,OAAO,CAAC,QAAS,OAAgB,OAAO;YAAC;SAAU,GAAG,EAAE;IACvE,EAAE,OAAO,KAAU;QACjB,QAAQ,IAAI,CAAC,oBAAoB,KAAK,WAAW;QACjD,OAAO,EAAE;IACX;AACF","debugId":null}},
    {"offset": {"line": 89, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/mpesa/stk/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { prisma, safeExecute, safeQuery } from '@/lib/db'\nconst SANDBOX_BASE = 'https://sandbox.safaricom.co.ke'\nconst LIVE_BASE = 'https://api.safaricom.co.ke'\n\nfunction formatTimestamp(d = new Date()) {\n  const pad = (n: number) => String(n).padStart(2, '0')\n  return (\n    d.getFullYear().toString() +\n    pad(d.getMonth() + 1) +\n    pad(d.getDate()) +\n    pad(d.getHours()) +\n    pad(d.getMinutes()) +\n    pad(d.getSeconds())\n  )\n}\n\nasync function getOAuthToken(baseUrl: string, key: string, secret: string) {\n  const basic = Buffer.from(`${key}:${secret}`).toString('base64')\n  const res = await fetch(`${baseUrl}/oauth/v1/generate?grant_type=client_credentials`, {\n    method: 'GET',\n    headers: { Authorization: `Basic ${basic}` },\n  })\n  if (!res.ok) throw new Error(`OAuth request failed: ${res.status}`)\n  return res.json()\n}\n\nasync function ensureMpesaTable() {\n  await safeExecute(`\n    CREATE TABLE IF NOT EXISTS mpesa_donations (\n      id SERIAL PRIMARY KEY,\n      amount NUMERIC,\n      phone TEXT,\n      account_reference TEXT,\n      transaction_desc TEXT,\n      merchant_request_id TEXT,\n      checkout_request_id TEXT,\n      response_code TEXT,\n      response_description TEXT,\n      provider_response JSONB,\n      mpesa_transaction_id TEXT,\n      status TEXT DEFAULT 'pending',\n      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),\n      updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()\n    )\n  `)\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json().catch(() => ({}))\n    const { phone, amount, accountReference, transactionDesc } = body || {}\n    if (!phone || !amount) return NextResponse.json({ error: 'Missing phone or amount' }, { status: 400 })\n\n    // Normalize and validate phone number\n    let normalizedPhone = String(phone).replace(/\\D/g, '') // Remove non-digits\n    \n    // Handle different formats: 0712345678, 712345678, 254712345678, +254712345678\n    if (normalizedPhone.startsWith('0')) {\n      normalizedPhone = '254' + normalizedPhone.substring(1)\n    } else if (normalizedPhone.startsWith('7') || normalizedPhone.startsWith('1')) {\n      normalizedPhone = '254' + normalizedPhone\n    }\n    \n    // Validate format: Must be 254XXXXXXXXX (12 digits)\n    if (!/^254\\d{9}$/.test(normalizedPhone)) {\n      return NextResponse.json({ \n        error: 'Invalid phone number format. Use 254XXXXXXXXX (e.g., 254712345678)' \n      }, { status: 400 })\n    }\n\n    const env = process.env.MPESA_ENV || 'sandbox'\n    const baseUrl = env === 'production' ? LIVE_BASE : SANDBOX_BASE\n\n    const consumerKey = process.env.MPESA_CONSUMER_KEY\n    const consumerSecret = process.env.MPESA_CONSUMER_SECRET\n    let shortcode = process.env.MPESA_SHORTCODE\n    let passkey = process.env.MPESA_PASSKEY\n    const callbackUrl = process.env.MPESA_CALLBACK_URL || `${baseUrl}/` // fallback\n\n    if (!consumerKey || !consumerSecret) return NextResponse.json({ error: 'MPESA consumer credentials not configured' }, { status: 500 })\n\n    // For local sandbox testing, many Daraja sandboxes use shortcode 174379 with a known passkey.\n    // If running in sandbox and the configured shortcode/passkey appears to be a real Paybill\n    // (e.g. 247247) that the sandbox does not recognise, fall back to the common sandbox\n    // credentials to allow testing. In production do not override.\n    if (env === 'sandbox') {\n      const sandboxShortcode = '174379'\n      const sandboxPasskey = 'bfb279f9aa9bdbcf158e97dd71a467cd2e0c893059b10f78e6b72ada1ed2c919'\n      if (!shortcode || !passkey || shortcode === '247247') {\n        console.warn('Using sandbox shortcode/passkey fallback for STK testing')\n        shortcode = sandboxShortcode\n        passkey = sandboxPasskey\n      }\n    }\n\n    if (!shortcode || !passkey) return NextResponse.json({ error: 'MPESA shortcode or passkey not configured (and no sandbox fallback available)' }, { status: 500 })\n\n    await ensureMpesaTable()\n\n    // create pending record before calling provider\n    const inserted: any = await safeQuery(`INSERT INTO mpesa_donations (amount, phone, account_reference, transaction_desc, status, created_at, updated_at) VALUES ($1,$2,$3,$4,'pending',NOW(),NOW()) RETURNING id`,\n      amount, normalizedPhone, accountReference || null, transactionDesc || null)\n    const localId = inserted?.[0]?.id || null\n\n    // 1) Get OAuth token\n    let oauth: any\n    try {\n      oauth = await getOAuthToken(baseUrl, consumerKey, consumerSecret)\n    } catch (oauthErr: any) {\n      console.error('OAuth token fetch failed:', oauthErr?.message || oauthErr)\n      return NextResponse.json({ error: 'Failed to get OAuth token from M-Pesa', details: oauthErr?.message }, { status: 502 })\n    }\n    const accessToken = oauth?.access_token\n    if (!accessToken) {\n      console.error('OAuth response missing access_token:', oauth)\n      return NextResponse.json({ error: 'Failed to retrieve access token', oauth }, { status: 500 })\n    }\n\n    // 2) Build password and timestamp\n    const timestamp = formatTimestamp()\n    const password = Buffer.from(`${shortcode}${passkey}${timestamp}`).toString('base64')\n\n    const stkBody = {\n      BusinessShortCode: shortcode,\n      Password: password,\n      Timestamp: timestamp,\n      TransactionType: 'CustomerPayBillOnline',\n      Amount: amount,\n      PartyA: normalizedPhone,\n      PartyB: shortcode,\n      PhoneNumber: normalizedPhone,\n      CallBackURL: callbackUrl,\n      AccountReference: accountReference || String(normalizedPhone),\n      TransactionDesc: transactionDesc || 'Donation',\n    }\n\n    const stkRes = await fetch(`${baseUrl}/mpesa/stkpush/v1/processrequest`, {\n      method: 'POST',\n      headers: {\n        Authorization: `Bearer ${accessToken}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(stkBody),\n    })\n\n    const data = await stkRes.json().catch(() => ({}))\n    \n    if (!stkRes.ok) {\n      console.error('STK Push API failed:', { status: stkRes.status, statusText: stkRes.statusText, response: data })\n    }\n\n    // update local record with provider response identifiers\n    try {\n      await safeExecute(`UPDATE mpesa_donations SET merchant_request_id=$1, checkout_request_id=$2, response_code=$3, response_description=$4, provider_response=$5::jsonb, updated_at=NOW() WHERE id=$6`,\n        data?.MerchantRequestID || data?.merchantRequestID || null,\n        data?.CheckoutRequestID || data?.checkoutRequestID || null,\n        data?.ResponseCode || data?.responseCode || null,\n        data?.ResponseDescription || data?.responseDescription || null,\n        JSON.stringify(data || {}),\n        localId)\n    } catch (e) {\n      console.warn('Failed to update mpesa_donations with provider response', e)\n    }\n\n    return NextResponse.json({ localId, provider: data }, { status: stkRes.ok ? 200 : 502 })\n  } catch (e: any) {\n    console.error('STK Push error', e?.message || e)\n    return NextResponse.json({ error: e?.message || 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}