{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/user/profile/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { PrismaClient } from \"@prisma/client\"\nimport jwt from \"jsonwebtoken\"\n\nconst prisma = new PrismaClient()\n\nfunction getTokenFromRequest(req: Request): string | null {\n  const authHeader = req.headers.get(\"authorization\") || req.headers.get(\"Authorization\")\n  if (authHeader && authHeader.startsWith(\"Bearer \")) return authHeader.substring(7)\n\n  const cookie = req.headers.get(\"cookie\") || \"\"\n  const match = cookie.split(\";\").map((c) => c.trim()).find((c) => c.startsWith(\"token=\"))\n  return match ? match.split(\"=\")[1] : null\n}\n\nfunction mapUser(user: any) {\n  if (!user) return null\n  return {\n    id: user.id,\n    name: user.name || \"\",\n    email: user.email,\n    role: user.role,\n    phone: user.phone || \"\",\n    location: user.location || \"\",\n    bio: user.bio || \"\",\n    profileImage: user.profileImage || \"\",\n    isVolunteer: !!user.isVolunteer,\n    createdAt: user.createdAt,\n  }\n}\n\nasync function getAuthenticatedUser(req: Request) {\n  const token = getTokenFromRequest(req)\n  if (!token) return null\n  const secret = process.env.JWT_SECRET || \"dev-secret\"\n  try {\n    const payload: any = jwt.verify(token, secret)\n    const user = await prisma.user.findUnique({ where: { id: payload.userId } })\n    return user ? { db: user, payload } : null\n  } catch (e) {\n    return null\n  }\n}\n\nexport async function GET(req: Request) {\n  try {\n    const auth = await getAuthenticatedUser(req)\n    if (!auth) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n\n    return NextResponse.json({ user: mapUser(auth.db) })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 })\n  }\n}\n\nexport async function PATCH(req: Request) {\n  try {\n    const auth = await getAuthenticatedUser(req)\n    if (!auth) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n\n    const body = await req.json().catch(() => ({}))\n    const updates: Record<string, any> = {}\n    const { name, email, phone, location, bio, profileImage } = body || {}\n\n    if (typeof name === \"string\") updates.name = name.trim()\n    if (typeof email === \"string\") updates.email = email.trim().toLowerCase()\n    if (typeof phone === \"string\") updates.phone = phone.trim()\n    if (typeof location === \"string\") updates.location = location.trim()\n    if (typeof bio === \"string\") updates.bio = bio.trim()\n    if (typeof profileImage === \"string\") updates.profileImage = profileImage.trim()\n\n    if (Object.keys(updates).length === 0) {\n      return NextResponse.json({ error: \"No updates provided\" }, { status: 400 })\n    }\n\n    // Enforce email uniqueness when changed\n    if (updates.email && updates.email !== auth.db.email) {\n      const existing = await prisma.user.findFirst({ where: { email: { equals: updates.email, mode: \"insensitive\" } } })\n      if (existing && existing.id !== auth.db.id) {\n        return NextResponse.json({ error: \"Email already in use\" }, { status: 409 })\n      }\n    }\n\n    const updated = await prisma.user.update({ where: { id: auth.db.id }, data: updates })\n\n    // Keep volunteer applications tied to the new email if email changed\n    if (updates.email && updates.email !== auth.db.email) {\n      try {\n        await prisma.$executeRawUnsafe(\n          `UPDATE volunteer_applications SET email = $1 WHERE LOWER(email) = LOWER($2)`,\n          String(updates.email),\n          String(auth.db.email),\n        )\n      } catch (e) {\n        console.warn(\"Failed to sync volunteer applications email\", e)\n      }\n    }\n\n    // Refresh token so payload email stays in sync\n    const secret = process.env.JWT_SECRET || \"dev-secret\"\n    const token = jwt.sign({ userId: updated.id, role: updated.role, email: updated.email }, secret, { expiresIn: \"7d\" })\n    const cookie = `token=${token}; HttpOnly; Path=/; Max-Age=${7 * 24 * 60 * 60}; SameSite=Lax`\n\n    return NextResponse.json({ user: mapUser(updated), token }, { headers: { \"Set-Cookie\": cookie } })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: \"Server error\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}