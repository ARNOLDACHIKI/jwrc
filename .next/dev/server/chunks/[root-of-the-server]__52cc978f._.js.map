{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/events/signups/send-reminder/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { PrismaClient } from \"@prisma/client\"\nimport jwt from \"jsonwebtoken\"\n\nconst prisma = new PrismaClient()\n\nfunction getTokenFromHeaders(req: Request) {\n  const cookie = req.headers.get(\"cookie\") || \"\"\n  const match = cookie.split(\";\").map((c) => c.trim()).find((c) => c.startsWith(\"token=\"))\n  if (!match) return null\n  return match.split(\"=\")[1]\n}\n\nexport async function POST(req: Request) {\n  try {\n    // admin-only\n    const token = getTokenFromHeaders(req)\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    let payload: any = null\n    try {\n      payload = jwt.verify(token, secret)\n    } catch (e) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n    if (payload.role !== 'admin') return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\n\n    const body = await req.json()\n    const { eventId, signupIds } = body || {}\n    \n    if (!eventId) return NextResponse.json({ error: 'Missing eventId' }, { status: 400 })\n\n    // Get event details\n    const event = await prisma.event.findUnique({ where: { id: eventId } })\n    if (!event) return NextResponse.json({ error: 'Event not found' }, { status: 404 })\n\n    // Get signups to send reminders to\n    let signups: any[] = []\n    if (signupIds && Array.isArray(signupIds) && signupIds.length > 0) {\n      // Send to specific signups\n      const placeholders = signupIds.map((_, i) => `$${i + 2}`).join(',')\n      signups = await prisma.$queryRawUnsafe(\n        `SELECT id, name, email, phone FROM event_signups WHERE event_id = $1 AND id IN (${placeholders})`,\n        eventId,\n        ...signupIds\n      )\n    } else {\n      // Send to all signups for this event\n      signups = await prisma.$queryRawUnsafe(\n        `SELECT id, name, email, phone FROM event_signups WHERE event_id = $1`,\n        eventId\n      )\n    }\n\n    if (signups.length === 0) {\n      return NextResponse.json({ error: 'No signups found' }, { status: 404 })\n    }\n\n    // Check if SMTP is configured\n    if (!process.env.SMTP_HOST || !process.env.SMTP_USER) {\n      return NextResponse.json({ \n        error: 'Email not configured. Please set SMTP environment variables.',\n        details: 'SMTP_HOST, SMTP_USER, SMTP_PASS, SMTP_PORT are required'\n      }, { status: 500 })\n    }\n\n    // Send reminder emails\n    const nodemailer = await import('nodemailer')\n    const transporter = nodemailer.createTransport({\n      host: process.env.SMTP_HOST,\n      port: Number(process.env.SMTP_PORT || 587),\n      secure: (process.env.SMTP_SECURE === 'true'),\n      auth: { \n        user: process.env.SMTP_USER, \n        pass: process.env.SMTP_PASS \n      },\n    })\n\n    const formatDate = (date: Date) => {\n      return date.toLocaleString('en-US', { \n        weekday: 'long',\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n        hour: '2-digit',\n        minute: '2-digit'\n      })\n    }\n\n    let sent = 0\n    let failed = 0\n\n    for (const signup of signups) {\n      try {\n        const emailContent = `\nDear ${signup.name},\n\nThis is a friendly reminder about the upcoming event you signed up for:\n\nEvent: ${event.title}\n${event.description ? `\\n${event.description}\\n` : ''}\nDate & Time: ${formatDate(new Date(event.startsAt))}\n${event.location ? `Location: ${event.location}\\n` : ''}\n\nWe look forward to seeing you there!\n\nIf you have any questions, please don't hesitate to contact us.\n\nBest regards,\n${process.env.SITE_NAME || 'Jesus Worship and Restoration Church'}\n        `.trim()\n\n        await transporter.sendMail({\n          from: process.env.SMTP_FROM || process.env.SMTP_USER,\n          to: signup.email,\n          subject: `Reminder: ${event.title}`,\n          text: emailContent,\n        })\n\n        sent++\n      } catch (e) {\n        console.error(`Failed to send reminder to ${signup.email}:`, e)\n        failed++\n      }\n    }\n\n    return NextResponse.json({ \n      success: true,\n      sent,\n      failed,\n      total: signups.length,\n      message: `Sent ${sent} reminder(s) successfully${failed > 0 ? `, ${failed} failed` : ''}`\n    }, { status: 200 })\n\n  } catch (err) {\n    console.error('Send reminder error:', err)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAE/B,SAAS,oBAAoB,GAAY;IACvC,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC,aAAa;IAC5C,MAAM,QAAQ,OAAO,KAAK,CAAC,KAAK,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,IAAI,IAAI,CAAC,CAAC,IAAM,EAAE,UAAU,CAAC;IAC9E,IAAI,CAAC,OAAO,OAAO;IACnB,OAAO,MAAM,KAAK,CAAC,IAAI,CAAC,EAAE;AAC5B;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,aAAa;QACb,MAAM,QAAQ,oBAAoB;QAClC,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;QACzC,IAAI,CAAC,OAAO,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAC9E,IAAI,UAAe;QACnB,IAAI;YACF,UAAU,2MAAG,CAAC,MAAM,CAAC,OAAO;QAC9B,EAAE,OAAO,GAAG;YACV,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QACA,IAAI,QAAQ,IAAI,KAAK,SAAS,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;QAE7F,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,OAAO,EAAE,SAAS,EAAE,GAAG,QAAQ,CAAC;QAExC,IAAI,CAAC,SAAS,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkB,GAAG;YAAE,QAAQ;QAAI;QAEnF,oBAAoB;QACpB,MAAM,QAAQ,MAAM,OAAO,KAAK,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE,IAAI;YAAQ;QAAE;QACrE,IAAI,CAAC,OAAO,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkB,GAAG;YAAE,QAAQ;QAAI;QAEjF,mCAAmC;QACnC,IAAI,UAAiB,EAAE;QACvB,IAAI,aAAa,MAAM,OAAO,CAAC,cAAc,UAAU,MAAM,GAAG,GAAG;YACjE,2BAA2B;YAC3B,MAAM,eAAe,UAAU,GAAG,CAAC,CAAC,GAAG,IAAM,CAAC,CAAC,EAAE,IAAI,GAAG,EAAE,IAAI,CAAC;YAC/D,UAAU,MAAM,OAAO,eAAe,CACpC,CAAC,gFAAgF,EAAE,aAAa,CAAC,CAAC,EAClG,YACG;QAEP,OAAO;YACL,qCAAqC;YACrC,UAAU,MAAM,OAAO,eAAe,CACpC,CAAC,oEAAoE,CAAC,EACtE;QAEJ;QAEA,IAAI,QAAQ,MAAM,KAAK,GAAG;YACxB,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,8BAA8B;QAC9B,IAAI,CAAC,QAAQ,GAAG,CAAC,SAAS,IAAI,CAAC,QAAQ,GAAG,CAAC,SAAS,EAAE;YACpD,OAAO,+QAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;gBACP,SAAS;YACX,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,uBAAuB;QACvB,MAAM,aAAa;QACnB,MAAM,cAAc,WAAW,eAAe,CAAC;YAC7C,MAAM,QAAQ,GAAG,CAAC,SAAS;YAC3B,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;YACtC,QAAS,QAAQ,GAAG,CAAC,WAAW,KAAK;YACrC,MAAM;gBACJ,MAAM,QAAQ,GAAG,CAAC,SAAS;gBAC3B,MAAM,QAAQ,GAAG,CAAC,SAAS;YAC7B;QACF;QAEA,MAAM,aAAa,CAAC;YAClB,OAAO,KAAK,cAAc,CAAC,SAAS;gBAClC,SAAS;gBACT,MAAM;gBACN,OAAO;gBACP,KAAK;gBACL,MAAM;gBACN,QAAQ;YACV;QACF;QAEA,IAAI,OAAO;QACX,IAAI,SAAS;QAEb,KAAK,MAAM,UAAU,QAAS;YAC5B,IAAI;gBACF,MAAM,eAAe,CAAC;KACzB,EAAE,OAAO,IAAI,CAAC;;;;OAIZ,EAAE,MAAM,KAAK,CAAC;AACrB,EAAE,MAAM,WAAW,GAAG,CAAC,EAAE,EAAE,MAAM,WAAW,CAAC,EAAE,CAAC,GAAG,GAAG;aACzC,EAAE,WAAW,IAAI,KAAK,MAAM,QAAQ,GAAG;AACpD,EAAE,MAAM,QAAQ,GAAG,CAAC,UAAU,EAAE,MAAM,QAAQ,CAAC,EAAE,CAAC,GAAG,GAAG;;;;;;;AAOxD,EAAE,QAAQ,GAAG,CAAC,SAAS,IAAI,uCAAuC;QAC1D,CAAC,CAAC,IAAI;gBAEN,MAAM,YAAY,QAAQ,CAAC;oBACzB,MAAM,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,SAAS;oBACpD,IAAI,OAAO,KAAK;oBAChB,SAAS,CAAC,UAAU,EAAE,MAAM,KAAK,EAAE;oBACnC,MAAM;gBACR;gBAEA;YACF,EAAE,OAAO,GAAG;gBACV,QAAQ,KAAK,CAAC,CAAC,2BAA2B,EAAE,OAAO,KAAK,CAAC,CAAC,CAAC,EAAE;gBAC7D;YACF;QACF;QAEA,OAAO,+QAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT;YACA;YACA,OAAO,QAAQ,MAAM;YACrB,SAAS,CAAC,KAAK,EAAE,KAAK,yBAAyB,EAAE,SAAS,IAAI,CAAC,EAAE,EAAE,OAAO,OAAO,CAAC,GAAG,IAAI;QAC3F,GAAG;YAAE,QAAQ;QAAI;IAEnB,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF","debugId":null}}]
}