{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = global as unknown as { __prisma?: PrismaClient }\n\nconst prisma = globalForPrisma.__prisma ?? new PrismaClient()\nif (process.env.NODE_ENV !== 'production') globalForPrisma.__prisma = prisma\n\nexport async function safeExecute(sql: string, ...params: any[]) {\n  try {\n    return await prisma.$executeRawUnsafe(sql, ...params)\n  } catch (err: any) {\n    console.warn('DB execute failed:', err?.message || err)\n    return null\n  }\n}\n\nexport async function safeQuery<T = any>(sql: string, ...params: any[]): Promise<T[]> {\n  try {\n    const rows = await prisma.$queryRawUnsafe(sql, ...params)\n    return Array.isArray(rows) ? (rows as T[]) : (rows ? [rows as T] : [])\n  } catch (err: any) {\n    console.warn('DB query failed:', err?.message || err)\n    return []\n  }\n}\n\nexport { prisma }\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM;AAEN,MAAM,SAAS,gBAAgB,QAAQ,IAAI,IAAI,6IAAY;AAC3D,wCAA2C,gBAAgB,QAAQ,GAAG;AAE/D,eAAe,YAAY,GAAW,EAAE,GAAG,MAAa;IAC7D,IAAI;QACF,OAAO,MAAM,OAAO,iBAAiB,CAAC,QAAQ;IAChD,EAAE,OAAO,KAAU;QACjB,QAAQ,IAAI,CAAC,sBAAsB,KAAK,WAAW;QACnD,OAAO;IACT;AACF;AAEO,eAAe,UAAmB,GAAW,EAAE,GAAG,MAAa;IACpE,IAAI;QACF,MAAM,OAAO,MAAM,OAAO,eAAe,CAAC,QAAQ;QAClD,OAAO,MAAM,OAAO,CAAC,QAAS,OAAgB,OAAO;YAAC;SAAU,GAAG,EAAE;IACvE,EAAE,OAAO,KAAU;QACjB,QAAQ,IAAI,CAAC,oBAAoB,KAAK,WAAW;QACjD,OAAO,EAAE;IACX;AACF","debugId":null}},
    {"offset": {"line": 89, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/donations/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { safeExecute, safeQuery } from '@/lib/db'\n\nasync function ensureTable() {\n  await safeExecute(`\n    CREATE TABLE IF NOT EXISTS donations (\n      id SERIAL PRIMARY KEY,\n      amount NUMERIC,\n      currency TEXT,\n      kes_amount INTEGER,\n      method TEXT,\n      donor_name TEXT,\n      donor_email TEXT,\n      note TEXT,\n      created_at TIMESTAMP WITH TIME ZONE DEFAULT now()\n    )\n  `)\n}\n\nasync function ensureMpesaTable() {\n  await safeExecute(`\n    CREATE TABLE IF NOT EXISTS mpesa_donations (\n      id SERIAL PRIMARY KEY,\n      amount NUMERIC,\n      phone TEXT,\n      account_reference TEXT,\n      transaction_desc TEXT,\n      merchant_request_id TEXT,\n      checkout_request_id TEXT,\n      response_code TEXT,\n      response_description TEXT,\n      provider_response JSONB,\n      mpesa_transaction_id TEXT,\n      status TEXT DEFAULT 'pending',\n      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),\n      updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()\n    )\n  `)\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json().catch(() => ({}))\n    const { amount, currency, kesAmount, method, donor } = body || {}\n    if (!amount || !method) return NextResponse.json({ error: 'Missing amount or method' }, { status: 400 })\n\n    await ensureTable()\n    await safeExecute(`INSERT INTO donations (amount, currency, kes_amount, method, donor_name, donor_email, note, created_at) VALUES ($1,$2,$3,$4,$5,$6,$7,NOW())`,\n      amount, currency || 'USD', kesAmount || null, method, donor?.name || null, donor?.email || null, body?.note || null)\n\n    return NextResponse.json({ ok: true }, { status: 201 })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n\nexport async function GET() {\n  try {\n    await ensureTable()\n    await ensureMpesaTable()\n\n    const manual = await safeQuery<any>(\n      `SELECT id, amount, currency, kes_amount, method, donor_name, donor_email, note, created_at\n       FROM donations\n       ORDER BY created_at DESC\n       LIMIT 200`\n    )\n\n    const mpesa = await safeQuery<any>(\n      `SELECT id, amount, phone, account_reference, transaction_desc, merchant_request_id, checkout_request_id,\n              response_code, response_description, provider_response, mpesa_transaction_id, status,\n              created_at, updated_at\n       FROM mpesa_donations\n       ORDER BY created_at DESC\n       LIMIT 200`\n    )\n\n    const normalizeAmount = (val: any) => {\n      const n = Number(val)\n      return Number.isFinite(n) ? n : 0\n    }\n\n    const rows = [\n      ...manual.map((d: any) => ({\n        id: `manual-${d.id}`,\n        type: 'manual',\n        amount: normalizeAmount(d.amount || d.kes_amount),\n        currency: d.currency || 'KES',\n        method: d.method || 'mpesa',\n        donorName: d.donor_name || 'Anonymous',\n        donorEmail: d.donor_email || null,\n        note: d.note || null,\n        status: 'recorded',\n        createdAt: d.created_at,\n      })),\n      ...mpesa.map((d: any) => ({\n        id: `mpesa-${d.id}`,\n        type: 'mpesa',\n        amount: normalizeAmount(d.amount),\n        currency: 'KES',\n        method: 'mpesa',\n        phone: d.phone,\n        accountReference: d.account_reference,\n        checkoutRequestId: d.checkout_request_id,\n        merchantRequestId: d.merchant_request_id,\n        mpesaReceipt: d.mpesa_transaction_id,\n        providerResponse: d.provider_response,\n        status: d.status || 'pending',\n        createdAt: d.created_at,\n        updatedAt: d.updated_at,\n        description: d.transaction_desc,\n        responseCode: d.response_code,\n        responseDescription: d.response_description,\n      })),\n    ].sort((a: any, b: any) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())\n\n    return NextResponse.json({ donations: rows })\n  } catch (e: any) {\n    console.error('donations GET error', e?.message || e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}