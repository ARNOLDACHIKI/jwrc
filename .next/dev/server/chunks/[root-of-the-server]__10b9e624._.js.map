{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/volunteers/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { PrismaClient } from \"@prisma/client\"\nimport { randomUUID } from \"crypto\"\nimport jwt from \"jsonwebtoken\"\n\nconst prisma = new PrismaClient()\n\nasync function ensureTable() {\n  await prisma.$executeRawUnsafe(`\n    CREATE TABLE IF NOT EXISTS volunteer_applications (\n      id TEXT PRIMARY KEY,\n      name TEXT NOT NULL,\n      email TEXT NOT NULL,\n      phone TEXT,\n      role_id TEXT,\n      role_title TEXT,\n      status TEXT DEFAULT 'pending',\n      admin_message TEXT,\n      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),\n      responded_at TIMESTAMP WITH TIME ZONE\n    )\n  `)\n  await prisma.$executeRawUnsafe(`ALTER TABLE volunteer_applications ADD COLUMN IF NOT EXISTS admin_message TEXT`)\n}\n\nfunction getTokenFromHeaders(req: Request) {\n  const cookie = req.headers.get('cookie') || ''\n  const match = cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith('token='))\n  if (!match) return null\n  return match.split('=')[1]\n}\n\nexport async function POST(req: Request) {\n  // public: submit volunteer application\n  try {\n    const body = await req.json()\n    const { name, email, phone, roleId, roleTitle } = body || {}\n    const errors: Record<string,string> = {}\n    if (!name) errors.name = 'Name is required'\n    if (!email) errors.email = 'Email is required'\n    if (!roleId && !roleTitle) errors.role = 'Role is required'\n    if (Object.keys(errors).length) return NextResponse.json({ errors }, { status: 400 })\n\n    await ensureTable()\n    const id = randomUUID()\n    await prisma.$executeRawUnsafe(`INSERT INTO volunteer_applications (id, name, email, phone, role_id, role_title, status, created_at) VALUES ($1,$2,$3,$4,$5,$6,'pending',NOW())`, id, String(name), String(email), phone ? String(phone) : null, roleId ? String(roleId) : null, roleTitle ? String(roleTitle) : null)\n    return NextResponse.json({ application: { id, name, email, phone, roleId, roleTitle, status: 'pending' } }, { status: 201 })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n\nexport async function GET(req: Request) {\n  try {\n    const url = new URL(req.url)\n    const forEmail = url.searchParams.get('email')\n    // if email provided return applications for that email (public for user dashboard)\n    await ensureTable()\n    if (forEmail) {\n      const rows: any[] = await prisma.$queryRawUnsafe(`SELECT id, name, email, phone, role_id as \"roleId\", role_title as \"roleTitle\", status, admin_message as \"adminMessage\", created_at as \"createdAt\", responded_at as \"respondedAt\" FROM volunteer_applications WHERE lower(email) = lower($1) ORDER BY created_at DESC`, forEmail)\n      return NextResponse.json({ applications: rows })\n    }\n\n    // admin-only: list all\n    const token = getTokenFromHeaders(req)\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    let payload: any = null\n    try { payload = jwt.verify(token, secret) } catch (e) { return NextResponse.json({ error: 'Unauthorized' }, { status: 401 }) }\n    if (payload.role !== 'admin') return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\n\n    const rows: any[] = await prisma.$queryRawUnsafe(`SELECT id, name, email, phone, role_id as \"roleId\", role_title as \"roleTitle\", status, admin_message as \"adminMessage\", created_at as \"createdAt\", responded_at as \"respondedAt\" FROM volunteer_applications ORDER BY created_at DESC`)\n    return NextResponse.json({ applications: rows })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n\nexport async function PATCH(req: Request) {\n  // admin respond (approve/reject)\n  try {\n    const token = getTokenFromHeaders(req)\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    let payload: any = null\n    try { payload = jwt.verify(token, secret) } catch (e) { return NextResponse.json({ error: 'Unauthorized' }, { status: 401 }) }\n    if (payload.role !== 'admin') return NextResponse.json({ error: 'Forbidden' }, { status: 403 })\n\n    const body = await req.json()\n    const { id, action, message } = body || {}\n    if (!id || !action) return NextResponse.json({ error: 'Missing id or action' }, { status: 400 })\n    if (!['approve','reject'].includes(action)) return NextResponse.json({ error: 'Invalid action' }, { status: 400 })\n\n    await ensureTable()\n    const status = action === 'approve' ? 'approved' : 'rejected'\n    await prisma.$executeRawUnsafe(`UPDATE volunteer_applications SET status = $1, admin_message = $2, responded_at = NOW() WHERE id = $3`, status, message ? String(message) : null, id)\n    return NextResponse.json({ ok: true })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,IAAI,6IAAY;AAE/B,eAAe;IACb,MAAM,OAAO,iBAAiB,CAAC,CAAC;;;;;;;;;;;;;EAahC,CAAC;IACD,MAAM,OAAO,iBAAiB,CAAC,CAAC,8EAA8E,CAAC;AACjH;AAEA,SAAS,oBAAoB,GAAY;IACvC,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC,aAAa;IAC5C,MAAM,QAAQ,OAAO,KAAK,CAAC,KAAK,GAAG,CAAC,CAAA,IAAG,EAAE,IAAI,IAAI,IAAI,CAAC,CAAA,IAAG,EAAE,UAAU,CAAC;IACtE,IAAI,CAAC,OAAO,OAAO;IACnB,OAAO,MAAM,KAAK,CAAC,IAAI,CAAC,EAAE;AAC5B;AAEO,eAAe,KAAK,GAAY;IACrC,uCAAuC;IACvC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,MAAM,EAAE,SAAS,EAAE,GAAG,QAAQ,CAAC;QAC3D,MAAM,SAAgC,CAAC;QACvC,IAAI,CAAC,MAAM,OAAO,IAAI,GAAG;QACzB,IAAI,CAAC,OAAO,OAAO,KAAK,GAAG;QAC3B,IAAI,CAAC,UAAU,CAAC,WAAW,OAAO,IAAI,GAAG;QACzC,IAAI,OAAO,IAAI,CAAC,QAAQ,MAAM,EAAE,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE;QAAO,GAAG;YAAE,QAAQ;QAAI;QAEnF,MAAM;QACN,MAAM,KAAK,IAAA,mHAAU;QACrB,MAAM,OAAO,iBAAiB,CAAC,CAAC,+IAA+I,CAAC,EAAE,IAAI,OAAO,OAAO,OAAO,QAAQ,QAAQ,OAAO,SAAS,MAAM,SAAS,OAAO,UAAU,MAAM,YAAY,OAAO,aAAa;QACjT,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,aAAa;gBAAE;gBAAI;gBAAM;gBAAO;gBAAO;gBAAQ;gBAAW,QAAQ;YAAU;QAAE,GAAG;YAAE,QAAQ;QAAI;IAC5H,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC;QACd,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF;AAEO,eAAe,IAAI,GAAY;IACpC,IAAI;QACF,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;QAC3B,MAAM,WAAW,IAAI,YAAY,CAAC,GAAG,CAAC;QACtC,mFAAmF;QACnF,MAAM;QACN,IAAI,UAAU;YACZ,MAAM,OAAc,MAAM,OAAO,eAAe,CAAC,CAAC,oQAAoQ,CAAC,EAAE;YACzT,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,cAAc;YAAK;QAChD;QAEA,uBAAuB;QACvB,MAAM,QAAQ,oBAAoB;QAClC,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;QACzC,IAAI,CAAC,OAAO,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAC9E,IAAI,UAAe;QACnB,IAAI;YAAE,UAAU,2MAAG,CAAC,MAAM,CAAC,OAAO;QAAQ,EAAE,OAAO,GAAG;YAAE,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QAAG;QAC7H,IAAI,QAAQ,IAAI,KAAK,SAAS,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;QAE7F,MAAM,OAAc,MAAM,OAAO,eAAe,CAAC,CAAC,qOAAqO,CAAC;QACxR,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,cAAc;QAAK;IAChD,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC;QACd,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF;AAEO,eAAe,MAAM,GAAY;IACtC,iCAAiC;IACjC,IAAI;QACF,MAAM,QAAQ,oBAAoB;QAClC,MAAM,SAAS,QAAQ,GAAG,CAAC,UAAU,IAAI;QACzC,IAAI,CAAC,OAAO,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAC9E,IAAI,UAAe;QACnB,IAAI;YAAE,UAAU,2MAAG,CAAC,MAAM,CAAC,OAAO;QAAQ,EAAE,OAAO,GAAG;YAAE,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QAAG;QAC7H,IAAI,QAAQ,IAAI,KAAK,SAAS,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;QAE7F,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,EAAE,EAAE,MAAM,EAAE,OAAO,EAAE,GAAG,QAAQ,CAAC;QACzC,IAAI,CAAC,MAAM,CAAC,QAAQ,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAuB,GAAG;YAAE,QAAQ;QAAI;QAC9F,IAAI,CAAC;YAAC;YAAU;SAAS,CAAC,QAAQ,CAAC,SAAS,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;QAEhH,MAAM;QACN,MAAM,SAAS,WAAW,YAAY,aAAa;QACnD,MAAM,OAAO,iBAAiB,CAAC,CAAC,qGAAqG,CAAC,EAAE,QAAQ,UAAU,OAAO,WAAW,MAAM;QAClL,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,IAAI;QAAK;IACtC,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC;QACd,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF","debugId":null}}]
}