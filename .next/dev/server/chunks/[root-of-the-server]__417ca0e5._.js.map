{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = global as unknown as { __prisma?: PrismaClient }\n\nconst prisma = globalForPrisma.__prisma ?? new PrismaClient()\nif (process.env.NODE_ENV !== 'production') globalForPrisma.__prisma = prisma\n\nexport async function safeExecute(sql: string, ...params: any[]) {\n  try {\n    return await prisma.$executeRawUnsafe(sql, ...params)\n  } catch (err: any) {\n    console.warn('DB execute failed:', err?.message || err)\n    return null\n  }\n}\n\nexport async function safeQuery<T = any>(sql: string, ...params: any[]): Promise<T[]> {\n  try {\n    const rows = await prisma.$queryRawUnsafe(sql, ...params)\n    return Array.isArray(rows) ? (rows as T[]) : (rows ? [rows as T] : [])\n  } catch (err: any) {\n    console.warn('DB query failed:', err?.message || err)\n    return []\n  }\n}\n\nexport { prisma }\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,MAAM;AAEN,MAAM,SAAS,gBAAgB,QAAQ,IAAI,IAAI,6IAAY;AAC3D,wCAA2C,gBAAgB,QAAQ,GAAG;AAE/D,eAAe,YAAY,GAAW,EAAE,GAAG,MAAa;IAC7D,IAAI;QACF,OAAO,MAAM,OAAO,iBAAiB,CAAC,QAAQ;IAChD,EAAE,OAAO,KAAU;QACjB,QAAQ,IAAI,CAAC,sBAAsB,KAAK,WAAW;QACnD,OAAO;IACT;AACF;AAEO,eAAe,UAAmB,GAAW,EAAE,GAAG,MAAa;IACpE,IAAI;QACF,MAAM,OAAO,MAAM,OAAO,eAAe,CAAC,QAAQ;QAClD,OAAO,MAAM,OAAO,CAAC,QAAS,OAAgB,OAAO;YAAC;SAAU,GAAG,EAAE;IACvE,EAAE,OAAO,KAAU;QACjB,QAAQ,IAAI,CAAC,oBAAoB,KAAK,WAAW;QACjD,OAAO,EAAE;IACX;AACF","debugId":null}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/user/inbox/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { prisma, safeQuery, safeExecute } from '@/lib/db'\nimport jwt from 'jsonwebtoken'\n\n \n\nfunction getTokenFromHeaders(req: Request) {\n  const cookie = req.headers.get('cookie') || ''\n  const match = cookie.split(';').map(c => c.trim()).find(c => c.startsWith('token='))\n  if (!match) return null\n  return match.split('=')[1]\n}\n\nasync function ensureTable() {\n  try {\n    await prisma.$executeRawUnsafe(`\n      CREATE TABLE IF NOT EXISTS inbox_seen (\n        user_id TEXT PRIMARY KEY,\n        last_seen TIMESTAMP WITH TIME ZONE\n      )\n    `)\n    return true\n  } catch (err) {\n    console.warn('Database unavailable (inbox route) â€” skipping table ensure:', err?.message || err)\n    return false\n  }\n}\n\nexport async function GET(req: Request) {\n  try {\n    const token = getTokenFromHeaders(req)\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ lastSeen: null, unreadCount: 0 })\n    let payload: any = null\n    try { payload = jwt.verify(token, secret) } catch (e) { return NextResponse.json({ lastSeen: null, unreadCount: 0 }) }\n    const userId = payload.userId\n    const email = payload.email\n\n    const dbAvailable = await ensureTable()\n    let row: any[] = []\n    if (dbAvailable) {\n      try {\n        row = await safeQuery(`SELECT last_seen FROM inbox_seen WHERE user_id = $1`, String(userId))\n      } catch (err) {\n        console.warn('Query failed in inbox GET:', err?.message || err)\n        row = []\n      }\n    }\n    const lastSeen = row && row.length > 0 ? row[0].last_seen : null\n\n    // compute unread from suggestions and volunteer_applications\n    let unread = 0\n    if (lastSeen) {\n      const s: any[] = await safeQuery(`SELECT COUNT(*) as c FROM suggestions WHERE LOWER(email)=LOWER($1) AND ((responded_at IS NOT NULL AND responded_at > $2) OR (responded_at IS NULL AND created_at > $2))`, String(email), String(lastSeen))\n      const v: any[] = await safeQuery(`SELECT COUNT(*) as c FROM volunteer_applications WHERE LOWER(email)=LOWER($1) AND ((responded_at IS NOT NULL AND responded_at > $2) OR (responded_at IS NULL AND created_at > $2))`, String(email), String(lastSeen))\n      unread = (s[0]?.c || 0) + (v[0]?.c || 0)\n    } else {\n      // if never seen, count items that have admin responses/messages\n      const s: any[] = await safeQuery(`SELECT COUNT(*) as c FROM suggestions WHERE LOWER(email)=LOWER($1) AND admin_response IS NOT NULL`, String(email))\n      const v: any[] = await safeQuery(`SELECT COUNT(*) as c FROM volunteer_applications WHERE LOWER(email)=LOWER($1) AND admin_message IS NOT NULL`, String(email))\n      unread = (s[0]?.c || 0) + (v[0]?.c || 0)\n    }\n\n    return NextResponse.json({ lastSeen: lastSeen || null, unreadCount: Number(unread) })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ lastSeen: null, unreadCount: 0 })\n  }\n}\n\nexport async function PATCH(req: Request) {\n  try {\n    const token = getTokenFromHeaders(req)\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    if (!token) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    let payload: any = null\n    try { payload = jwt.verify(token, secret) } catch (e) { return NextResponse.json({ error: 'Unauthorized' }, { status: 401 }) }\n    const userId = payload.userId\n\n    const dbAvailable = await ensureTable()\n    if (!dbAvailable) return NextResponse.json({ error: 'Database unavailable' }, { status: 503 })\n    // set last_seen to now\n    await safeExecute(`INSERT INTO inbox_seen (user_id, last_seen) VALUES ($1, NOW()) ON CONFLICT (user_id) DO UPDATE SET last_seen = NOW()`, String(userId))\n    return NextResponse.json({ ok: true })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}