{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/lod/Downloads/jwrc/app/api/auth/password-reset/request/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { PrismaClient } from \"@prisma/client\"\nimport { randomBytes } from \"crypto\"\nimport bcrypt from \"bcryptjs\"\n\nconst prisma = new PrismaClient()\n\nasync function ensureTable() {\n  await prisma.$executeRawUnsafe(`\n    CREATE TABLE IF NOT EXISTS password_reset_tokens (\n      id TEXT PRIMARY KEY,\n      user_id TEXT NOT NULL,\n      token TEXT NOT NULL,\n      expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n      used BOOLEAN DEFAULT false,\n      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),\n      used_at TIMESTAMP WITH TIME ZONE\n    )\n  `)\n  await prisma.$executeRawUnsafe(`CREATE INDEX IF NOT EXISTS password_reset_tokens_token_idx ON password_reset_tokens(token)`)\n}\n\nasync function findUserByEmail(email: string) {\n  // try exact then case-insensitive\n  let user = await prisma.user.findUnique({ where: { email } })\n  if (!user) {\n    try {\n      user = await prisma.user.findFirst({ where: { email: { equals: email, mode: 'insensitive' } } })\n    } catch (e) {\n      // ignore\n    }\n  }\n  return user\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json()\n    const { email } = body || {}\n    if (!email) return NextResponse.json({ error: 'Email required' }, { status: 400 })\n\n    const user = await findUserByEmail(String(email))\n    await ensureTable()\n    if (!user) {\n      return NextResponse.json({ \n        error: 'No account found with this email address. Please register first.' \n      }, { status: 404 })\n    }\n\n    const token = randomBytes(24).toString('hex')\n    const id = randomBytes(12).toString('hex')\n    const expiresAt = new Date(Date.now() + 1000 * 60 * 60) // 1 hour\n\n    await prisma.$executeRawUnsafe(`INSERT INTO password_reset_tokens (id, user_id, token, expires_at, used, created_at) VALUES ($1,$2,$3,$4,false,NOW())`, id, user.id, token, expiresAt)\n\n    // try to send email if SMTP configured\n    try {\n      if (process.env.SMTP_HOST && process.env.SMTP_USER) {\n        const nodemailer = await import('nodemailer')\n        const transporter = nodemailer.createTransport({\n          host: process.env.SMTP_HOST,\n          port: Number(process.env.SMTP_PORT || 587),\n          secure: (process.env.SMTP_SECURE === 'true'),\n          auth: { user: process.env.SMTP_USER, pass: process.env.SMTP_PASS }\n        })\n        const site = process.env.SITE_URL || 'http://localhost:3000'\n        const resetLink = `${site}/reset-password?token=${token}`\n        await transporter.sendMail({\n          from: process.env.SMTP_FROM || process.env.SMTP_USER,\n          to: user.email,\n          subject: 'Password reset request',\n          text: `You requested a password reset. Use this link to reset your password: ${resetLink} (expires in 1 hour)`\n        })\n        return NextResponse.json({ ok: true })\n      }\n    } catch (e) {\n      console.warn('Failed to send password reset email', e)\n    }\n\n    // SMTP not configured or send failed â€” return token for manual testing (only in dev)\n    if ((process.env.NODE_ENV || 'development') === 'development') {\n      return NextResponse.json({ ok: true, token })\n    }\n\n    return NextResponse.json({ ok: true })\n  } catch (e) {\n    console.error(e)\n    return NextResponse.json({ error: 'Server error' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAGA,MAAM,SAAS,IAAI,6IAAY;AAE/B,eAAe;IACb,MAAM,OAAO,iBAAiB,CAAC,CAAC;;;;;;;;;;EAUhC,CAAC;IACD,MAAM,OAAO,iBAAiB,CAAC,CAAC,0FAA0F,CAAC;AAC7H;AAEA,eAAe,gBAAgB,KAAa;IAC1C,kCAAkC;IAClC,IAAI,OAAO,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;QAAE,OAAO;YAAE;QAAM;IAAE;IAC3D,IAAI,CAAC,MAAM;QACT,IAAI;YACF,OAAO,MAAM,OAAO,IAAI,CAAC,SAAS,CAAC;gBAAE,OAAO;oBAAE,OAAO;wBAAE,QAAQ;wBAAO,MAAM;oBAAc;gBAAE;YAAE;QAChG,EAAE,OAAO,GAAG;QACV,SAAS;QACX;IACF;IACA,OAAO;AACT;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,KAAK,EAAE,GAAG,QAAQ,CAAC;QAC3B,IAAI,CAAC,OAAO,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAiB,GAAG;YAAE,QAAQ;QAAI;QAEhF,MAAM,OAAO,MAAM,gBAAgB,OAAO;QAC1C,MAAM;QACN,IAAI,CAAC,MAAM;YACT,OAAO,+QAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,MAAM,QAAQ,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;QACvC,MAAM,KAAK,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;QACpC,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,OAAO,KAAK,IAAI,SAAS;;QAEjE,MAAM,OAAO,iBAAiB,CAAC,CAAC,qHAAqH,CAAC,EAAE,IAAI,KAAK,EAAE,EAAE,OAAO;QAE5K,uCAAuC;QACvC,IAAI;YACF,IAAI,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,SAAS,EAAE;gBAClD,MAAM,aAAa;gBACnB,MAAM,cAAc,WAAW,eAAe,CAAC;oBAC7C,MAAM,QAAQ,GAAG,CAAC,SAAS;oBAC3B,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;oBACtC,QAAS,QAAQ,GAAG,CAAC,WAAW,KAAK;oBACrC,MAAM;wBAAE,MAAM,QAAQ,GAAG,CAAC,SAAS;wBAAE,MAAM,QAAQ,GAAG,CAAC,SAAS;oBAAC;gBACnE;gBACA,MAAM,OAAO,QAAQ,GAAG,CAAC,QAAQ,IAAI;gBACrC,MAAM,YAAY,GAAG,KAAK,sBAAsB,EAAE,OAAO;gBACzD,MAAM,YAAY,QAAQ,CAAC;oBACzB,MAAM,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,SAAS;oBACpD,IAAI,KAAK,KAAK;oBACd,SAAS;oBACT,MAAM,CAAC,sEAAsE,EAAE,UAAU,oBAAoB,CAAC;gBAChH;gBACA,OAAO,+QAAY,CAAC,IAAI,CAAC;oBAAE,IAAI;gBAAK;YACtC;QACF,EAAE,OAAO,GAAG;YACV,QAAQ,IAAI,CAAC,uCAAuC;QACtD;QAEA,qFAAqF;QACrF,wCAA+D;YAC7D,OAAO,+QAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAM;YAAM;QAC7C;;;IAGF,EAAE,OAAO,GAAG;QACV,QAAQ,KAAK,CAAC;QACd,OAAO,+QAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;AACF","debugId":null}}]
}