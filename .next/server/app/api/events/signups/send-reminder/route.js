"use strict";(()=>{var e={};e.id=5715,e.ids=[5715],e.modules={96330:e=>{e.exports=require("@prisma/client")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{e.exports=require("assert")},79428:e=>{e.exports=require("buffer")},79646:e=>{e.exports=require("child_process")},55511:e=>{e.exports=require("crypto")},14985:e=>{e.exports=require("dns")},94735:e=>{e.exports=require("events")},29021:e=>{e.exports=require("fs")},81630:e=>{e.exports=require("http")},55591:e=>{e.exports=require("https")},91645:e=>{e.exports=require("net")},21820:e=>{e.exports=require("os")},33873:e=>{e.exports=require("path")},27910:e=>{e.exports=require("stream")},34631:e=>{e.exports=require("tls")},79551:e=>{e.exports=require("url")},28354:e=>{e.exports=require("util")},74075:e=>{e.exports=require("zlib")},37932:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>R,routeModule:()=>x,serverHooks:()=>h,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>S});var n={};t.r(n),t.d(n,{POST:()=>f,dynamic:()=>v});var s=t(62137),i=t(63654),o=t(48093),a=t(63e3),u=t(96330),d=t(77136),p=t.n(d),l=t(52437),c=t(4873);let m=new u.PrismaClient,v="force-dynamic";async function f(e){try{let r=function(e){let r=(e.headers.get("cookie")||"").split(";").map(e=>e.trim()).find(e=>e.startsWith("token="));return r?r.split("=")[1]:null}(e),n=process.env.JWT_SECRET||"dev-secret";if(!r)return a.NextResponse.json({error:"Unauthorized"},{status:401});let s=null;try{s=p().verify(r,n)}catch(e){return a.NextResponse.json({error:"Unauthorized"},{status:401})}if("admin"!==s.role)return a.NextResponse.json({error:"Forbidden"},{status:403});let{eventId:i,signupIds:o}=await e.json()||{};if(!i)return a.NextResponse.json({error:"Missing eventId"},{status:400});let u=await m.event.findUnique({where:{id:i}});if(!u)return a.NextResponse.json({error:"Event not found"},{status:404});let d=[];if(o&&Array.isArray(o)&&o.length>0){let e=o.map((e,r)=>`$${r+2}`).join(",");d=await m.$queryRawUnsafe(`SELECT id, event_id, ref, name, email, phone FROM event_signups WHERE event_id = $1 AND id IN (${e})`,i,...o)}else d=await m.$queryRawUnsafe("SELECT id, event_id, ref, name, email, phone FROM event_signups WHERE event_id = $1",i);if(0===d.length)return a.NextResponse.json({error:"No signups found"},{status:404});if(!process.env.SMTP_HOST||!process.env.SMTP_USER)return a.NextResponse.json({error:"Email not configured. Please set SMTP environment variables.",details:"SMTP_HOST, SMTP_USER, SMTP_PASS, SMTP_PORT are required"},{status:500});let v=(await t.e(3040).then(t.t.bind(t,83040,19))).createTransport({host:process.env.SMTP_HOST,port:Number(process.env.SMTP_PORT||587),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}}),f=e=>e.toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),x=0,g=0;for(let e of d)try{let r=await (0,l.E)({eventId:e.event_id,signupId:e.id,ref:e.ref||"",name:e.name,email:e.email});console.log(`Generated QR code for ${e.email}, length: ${r.length}`);let t=r.split(",")[1],n=(0,c.Fj)(e.name,u.title,f(new Date(u.startsAt)),u.location||void 0,e.ref||"N/A","cid:qrcode@ticket");await v.sendMail({from:process.env.SMTP_FROM||process.env.SMTP_USER,to:e.email,subject:`Reminder: ${u.title} - Your Ticket Inside`,html:n.html,text:n.text,attachments:[{filename:"qrcode.png",content:t,encoding:"base64",cid:"qrcode@ticket"}]}),await m.$executeRawUnsafe("UPDATE event_signups SET ticket_sent = true WHERE id = $1",e.id),x++}catch(r){console.error(`Failed to send reminder to ${e.email}:`,r),g++}return a.NextResponse.json({success:!0,sent:x,failed:g,total:d.length,message:`Sent ${x} reminder(s) successfully${g>0?`, ${g} failed`:""}`},{status:200})}catch(e){return console.error("Send reminder error:",e),a.NextResponse.json({error:"Server error"},{status:500})}}let x=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/events/signups/send-reminder/route",pathname:"/api/events/signups/send-reminder",filename:"route",bundlePath:"app/api/events/signups/send-reminder/route"},resolvedPagePath:"/home/lod/Downloads/jwrc/app/api/events/signups/send-reminder/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:g,workUnitAsyncStorage:S,serverHooks:h}=x;function R(){return(0,o.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:S})}},52437:(e,r,t)=>{t.d(r,{E:()=>s,U:()=>i});var n=t(55953);async function s(e){let r=JSON.stringify({type:"event-ticket",eventId:e.eventId,signupId:e.signupId,ref:e.ref,name:e.name,email:e.email,timestamp:new Date().toISOString()});return await n.toDataURL(r,{errorCorrectionLevel:"H",type:"image/png",width:300,margin:2,color:{dark:"#000000",light:"#FFFFFF"}})}function i(e){try{let r=JSON.parse(e);if("event-ticket"!==r.type)return{valid:!1,error:"Invalid ticket type"};if(!r.eventId||!r.signupId||!r.ref)return{valid:!1,error:"Missing required ticket data"};return{valid:!0,data:r}}catch(e){return{valid:!1,error:"Invalid QR code data"}}}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[5089,9862,7136,5953,9289],()=>t(37932));module.exports=n})();