"use strict";(()=>{var e={};e.id=8263,e.ids=[8263],e.modules={96330:e=>{e.exports=require("@prisma/client")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{e.exports=require("buffer")},79646:e=>{e.exports=require("child_process")},55511:e=>{e.exports=require("crypto")},14985:e=>{e.exports=require("dns")},94735:e=>{e.exports=require("events")},29021:e=>{e.exports=require("fs")},81630:e=>{e.exports=require("http")},55591:e=>{e.exports=require("https")},91645:e=>{e.exports=require("net")},21820:e=>{e.exports=require("os")},33873:e=>{e.exports=require("path")},27910:e=>{e.exports=require("stream")},34631:e=>{e.exports=require("tls")},79551:e=>{e.exports=require("url")},28354:e=>{e.exports=require("util")},74075:e=>{e.exports=require("zlib")},34648:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>N,routeModule:()=>g,serverHooks:()=>w,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>h});var s={};t.r(s),t.d(s,{DELETE:()=>f,GET:()=>S,POST:()=>R,dynamic:()=>v});var n=t(62137),o=t(63654),i=t(48093),a=t(63e3),u=t(96330),p=t(77136),d=t.n(p),c=t(55511),l=t(4873);let E=new u.PrismaClient;function T(e){let r=(e.headers.get("cookie")||"").split(";").map(e=>e.trim()).find(e=>e.startsWith("token="));return r?r.split("=")[1]:null}async function x(){await E.$executeRawUnsafe(`
    CREATE TABLE IF NOT EXISTS event_signups (
      id TEXT PRIMARY KEY,
      event_id TEXT NOT NULL,
      ref TEXT UNIQUE,
      name TEXT NOT NULL,
      email TEXT NOT NULL,
      phone TEXT,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
    )
  `),await E.$executeRawUnsafe("ALTER TABLE event_signups ADD COLUMN IF NOT EXISTS ref TEXT"),await E.$executeRawUnsafe("CREATE UNIQUE INDEX IF NOT EXISTS event_signups_ref_idx ON event_signups(ref)")}let v="force-dynamic";async function R(e){try{let{eventId:s,name:n,email:o,phone:i}=await e.json()||{},u={};if(s||(u.eventId="Event id is required"),n&&0!==String(n).trim().length||(u.name="Name is required"),o&&0!==String(o).trim().length||(u.email="Email is required"),Object.keys(u).length>0)return a.NextResponse.json({errors:u},{status:400});let p=await E.event.findUnique({where:{id:s}});if(!p)return a.NextResponse.json({error:"Event not found"},{status:404});await x(),await x();let d=await E.$queryRawUnsafe("SELECT id FROM event_signups WHERE event_id = $1 AND lower(email) = lower($2) LIMIT 1",s,String(o));if(d&&d.length>0)return a.NextResponse.json({error:"Already signed up"},{status:409});function r(){return Date.now().toString(36)+Math.random().toString(36).slice(2,6)}let T=r();for(let e=0;e<5;e++){let e=await E.$queryRawUnsafe("SELECT id FROM event_signups WHERE ref = $1 LIMIT 1",T);if(!Array.isArray(e)||0===e.length)break;T=r()}let v=(0,c.randomUUID)();await E.$executeRawUnsafe("INSERT INTO event_signups (id, event_id, ref, name, email, phone, created_at) VALUES ($1,$2,$3,$4,$5,$6,NOW())",v,s,T,String(n),String(o),i?String(i):null);try{if(process.env.SMTP_HOST&&process.env.SMTP_USER)try{let e=(await t.e(3040).then(t.t.bind(t,83040,19))).createTransport({host:process.env.SMTP_HOST,port:Number(process.env.SMTP_PORT||587),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}}),r=(0,l.YP)(n,p.title,new Date(p.startsAt).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),p.location||void 0,T||void 0);await e.sendMail({from:process.env.SMTP_FROM||process.env.SMTP_USER,to:String(o),subject:r.subject,html:r.html,text:r.text})}catch(e){console.warn("Failed to send confirmation email",e)}}catch(e){console.warn("Email send skipped",e)}return a.NextResponse.json({signup:{id:v,ref:T,eventId:s,name:n,email:o,phone:i}},{status:201})}catch(e){return console.error(e),a.NextResponse.json({error:"Server error"},{status:500})}}async function f(e){try{let r=T(e),t=process.env.JWT_SECRET||"dev-secret";if(!r)return a.NextResponse.json({error:"Unauthorized"},{status:401});let s=null;try{s=d().verify(r,t)}catch(e){return a.NextResponse.json({error:"Unauthorized"},{status:401})}if("admin"!==s.role)return a.NextResponse.json({error:"Forbidden"},{status:403});let{id:n}=await e.json()||{};if(!n)return a.NextResponse.json({error:"Missing id"},{status:400});await x();try{return await E.$executeRawUnsafe("DELETE FROM event_signups WHERE id = $1",n),a.NextResponse.json({ok:!0})}catch(e){return console.error(e),a.NextResponse.json({error:"Failed to delete"},{status:500})}}catch(e){return console.error(e),a.NextResponse.json({error:"Server error"},{status:500})}}async function S(e){try{let r=T(e),t=process.env.JWT_SECRET||"dev-secret";if(!r)return a.NextResponse.json({error:"Unauthorized"},{status:401});let s=null;try{s=d().verify(r,t)}catch(e){return a.NextResponse.json({error:"Unauthorized"},{status:401})}if("admin"!==s.role)return a.NextResponse.json({error:"Forbidden"},{status:403});let n=new URL(e.url).searchParams.get("eventId");if(!n)return a.NextResponse.json({error:"Missing eventId"},{status:400});await x();let o=await E.$queryRawUnsafe('SELECT id, ref, event_id as eventId, name, email, phone, created_at as "createdAt" FROM event_signups WHERE event_id = $1 ORDER BY created_at DESC',n);return a.NextResponse.json({signups:o})}catch(e){return console.error(e),a.NextResponse.json({error:"Server error"},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/events/signups/route",pathname:"/api/events/signups",filename:"route",bundlePath:"app/api/events/signups/route"},resolvedPagePath:"/home/lod/Downloads/jwrc/app/api/events/signups/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:h,serverHooks:w}=g;function N(){return(0,i.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:h})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[5089,9862,7136,9289],()=>t(34648));module.exports=s})();