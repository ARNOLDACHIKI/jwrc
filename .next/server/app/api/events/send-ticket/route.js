"use strict";(()=>{var e={};e.id=9699,e.ids=[9699],e.modules={96330:e=>{e.exports=require("@prisma/client")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{e.exports=require("assert")},79428:e=>{e.exports=require("buffer")},79646:e=>{e.exports=require("child_process")},55511:e=>{e.exports=require("crypto")},14985:e=>{e.exports=require("dns")},94735:e=>{e.exports=require("events")},29021:e=>{e.exports=require("fs")},81630:e=>{e.exports=require("http")},55591:e=>{e.exports=require("https")},91645:e=>{e.exports=require("net")},21820:e=>{e.exports=require("os")},33873:e=>{e.exports=require("path")},27910:e=>{e.exports=require("stream")},34631:e=>{e.exports=require("tls")},79551:e=>{e.exports=require("url")},28354:e=>{e.exports=require("util")},74075:e=>{e.exports=require("zlib")},59880:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>k,routeModule:()=>g,serverHooks:()=>S,workAsyncStorage:()=>q,workUnitAsyncStorage:()=>h});var s={};t.r(s),t.d(s,{POST:()=>f,dynamic:()=>x});var n=t(62137),i=t(63654),o=t(48093),a=t(63e3),u=t(96330),p=t(83040),d=t(77136),c=t.n(d),l=t(52437),v=t(4873);let m=new u.PrismaClient,x="force-dynamic";async function f(e){try{let r=function(e){let r=(e.headers.get("cookie")||"").split(";").map(e=>e.trim()).find(e=>e.startsWith("token="));return r?r.split("=")[1]:null}(e),t=process.env.JWT_SECRET||"dev-secret";if(!r)return a.NextResponse.json({error:"Unauthorized"},{status:401});let s=null;try{s=c().verify(r,t)}catch(e){return a.NextResponse.json({error:"Unauthorized"},{status:401})}if("admin"!==s.role)return a.NextResponse.json({error:"Forbidden - Admin access required"},{status:403});let{signupId:n,eventId:i}=await e.json()||{};if(!n)return a.NextResponse.json({error:"Signup ID is required"},{status:400});let o=await m.$queryRawUnsafe("SELECT * FROM event_signups WHERE id = $1 LIMIT 1",n);if(!Array.isArray(o)||0===o.length)return a.NextResponse.json({error:"Event signup not found"},{status:404});let u=o[0],d=await m.event.findUnique({where:{id:u.event_id}});if(!d)return a.NextResponse.json({error:"Event not found"},{status:404});let x=await (0,l.E)({eventId:u.event_id,signupId:u.id,ref:u.ref||"",name:u.name,email:u.email});if(!process.env.SMTP_HOST||!process.env.SMTP_USER)return a.NextResponse.json({error:"Email service not configured"},{status:500});let f=p.createTransport({host:process.env.SMTP_HOST,port:Number(process.env.SMTP_PORT||587),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}}),g=x.split(",")[1],q=(0,v.Fj)(u.name,d.title,new Date(d.startsAt).toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),d.location||void 0,u.ref||"N/A","cid:qrcode@ticket");return await f.sendMail({from:process.env.SMTP_FROM||process.env.SMTP_USER,to:u.email,subject:q.subject,html:q.html,text:q.text,attachments:[{filename:"qrcode.png",content:g,encoding:"base64",cid:"qrcode@ticket"}]}),await m.$executeRawUnsafe("UPDATE event_signups SET ticket_sent = true WHERE id = $1",n),a.NextResponse.json({ok:!0,message:"Ticket sent successfully",email:u.email},{status:200})}catch(e){return console.error("Error sending ticket:",e),a.NextResponse.json({error:"Failed to send ticket"},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/events/send-ticket/route",pathname:"/api/events/send-ticket",filename:"route",bundlePath:"app/api/events/send-ticket/route"},resolvedPagePath:"/home/lod/Downloads/jwrc/app/api/events/send-ticket/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:q,workUnitAsyncStorage:h,serverHooks:S}=g;function k(){return(0,o.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:h})}},52437:(e,r,t)=>{t.d(r,{E:()=>n,U:()=>i});var s=t(55953);async function n(e){let r=JSON.stringify({type:"event-ticket",eventId:e.eventId,signupId:e.signupId,ref:e.ref,name:e.name,email:e.email,timestamp:new Date().toISOString()});return await s.toDataURL(r,{errorCorrectionLevel:"H",type:"image/png",width:300,margin:2,color:{dark:"#000000",light:"#FFFFFF"}})}function i(e){try{let r=JSON.parse(e);if("event-ticket"!==r.type)return{valid:!1,error:"Invalid ticket type"};if(!r.eventId||!r.signupId||!r.ref)return{valid:!1,error:"Missing required ticket data"};return{valid:!0,data:r}}catch(e){return{valid:!1,error:"Invalid QR code data"}}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[5089,9862,7136,3040,5953,9289],()=>t(59880));module.exports=s})();