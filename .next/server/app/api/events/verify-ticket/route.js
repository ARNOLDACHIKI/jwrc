(()=>{var e={};e.id=8908,e.ids=[8908],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},29021:e=>{"use strict";e.exports=require("fs")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},21125:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>g,routeModule:()=>y,serverHooks:()=>k,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>R});var s={};r.r(s),r.d(s,{PATCH:()=>h,POST:()=>x,dynamic:()=>f});var n=r(62137),i=r(63654),o=r(48093),a=r(63e3),u=r(96330),d=r(77136),c=r.n(d),p=r(52437);let l=new u.PrismaClient;function v(e){let t=(e.headers.get("cookie")||"").split(";").map(e=>e.trim()).find(e=>e.startsWith("token="));return t?t.split("=")[1]:null}let f="force-dynamic";async function x(e){try{let t=v(e),r=process.env.JWT_SECRET||"dev-secret";if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});let s=null;try{s=c().verify(t,r)}catch(e){return a.NextResponse.json({error:"Unauthorized"},{status:401})}if("admin"!==s.role&&"leader"!==s.role)return a.NextResponse.json({error:"Forbidden - Admin or Leader access required"},{status:403});let{qrData:n}=await e.json()||{};if(!n)return a.NextResponse.json({error:"QR code data is required"},{status:400});let i=(0,p.U)(n);if(!i.valid)return a.NextResponse.json({error:i.error||"Invalid QR code"},{status:400});let o=i.data,u=await l.$queryRawUnsafe("SELECT * FROM event_signups WHERE id = $1 AND event_id = $2 LIMIT 1",o.signupId,o.eventId);if(!Array.isArray(u)||0===u.length)return a.NextResponse.json({error:"Ticket not found or invalid",valid:!1},{status:404});let d=u[0];if(d.ref!==o.ref)return a.NextResponse.json({error:"Ticket reference mismatch",valid:!1},{status:400});let f=await l.event.findUnique({where:{id:d.event_id}});if(!f)return a.NextResponse.json({error:"Event not found"},{status:404});let x=!0===d.checked_in;return a.NextResponse.json({valid:!0,alreadyCheckedIn:x,signup:{id:d.id,name:d.name,email:d.email,phone:d.phone,ref:d.ref,checkedIn:d.checked_in,checkedInAt:d.checked_in_at},event:{id:f.id,title:f.title,startsAt:f.startsAt,location:f.location}},{status:200})}catch(e){return console.error("Error verifying ticket:",e),a.NextResponse.json({error:"Failed to verify ticket"},{status:500})}}async function h(e){try{let t=v(e),r=process.env.JWT_SECRET||"dev-secret";if(!t)return a.NextResponse.json({error:"Unauthorized"},{status:401});let s=null;try{s=c().verify(t,r)}catch(e){return a.NextResponse.json({error:"Unauthorized"},{status:401})}if("admin"!==s.role&&"leader"!==s.role)return a.NextResponse.json({error:"Forbidden"},{status:403});let{signupId:n}=await e.json()||{};if(!n)return a.NextResponse.json({error:"Signup ID is required"},{status:400});await l.$executeRawUnsafe("UPDATE event_signups SET checked_in = true, checked_in_at = NOW() WHERE id = $1",n);let i=await l.$queryRawUnsafe("SELECT * FROM event_signups WHERE id = $1 LIMIT 1",n);if(!Array.isArray(i)||0===i.length)return a.NextResponse.json({error:"Signup not found"},{status:404});return a.NextResponse.json({ok:!0,message:"Checked in successfully",signup:i[0]},{status:200})}catch(e){return console.error("Error checking in:",e),a.NextResponse.json({error:"Failed to check in"},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/events/verify-ticket/route",pathname:"/api/events/verify-ticket",filename:"route",bundlePath:"app/api/events/verify-ticket/route"},resolvedPagePath:"/home/lod/Downloads/jwrc/app/api/events/verify-ticket/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:R,serverHooks:k}=y;function g(){return(0,o.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:R})}},62290:()=>{},51674:()=>{},52437:(e,t,r)=>{"use strict";r.d(t,{E:()=>n,U:()=>i});var s=r(55953);async function n(e){let t=JSON.stringify({type:"event-ticket",eventId:e.eventId,signupId:e.signupId,ref:e.ref,name:e.name,email:e.email,timestamp:new Date().toISOString()});return await s.toDataURL(t,{errorCorrectionLevel:"H",type:"image/png",width:300,margin:2,color:{dark:"#000000",light:"#FFFFFF"}})}function i(e){try{let t=JSON.parse(e);if("event-ticket"!==t.type)return{valid:!1,error:"Invalid ticket type"};if(!t.eventId||!t.signupId||!t.ref)return{valid:!1,error:"Missing required ticket data"};return{valid:!0,data:t}}catch(e){return{valid:!1,error:"Invalid QR code data"}}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[5089,9862,7136,5953],()=>r(21125));module.exports=s})();