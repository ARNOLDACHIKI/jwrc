(()=>{var e={};e.id=6799,e.ids=[6799],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},5489:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>m,routeModule:()=>x,serverHooks:()=>h,workAsyncStorage:()=>E,workUnitAsyncStorage:()=>T});var r={};s.r(r),s.d(r,{POST:()=>l,dynamic:()=>d});var n=s(62137),o=s(63654),a=s(48093),i=s(63e3);let c=new(s(96330)).PrismaClient;async function u(e,t,s){let r=Buffer.from(`${t}:${s}`).toString("base64"),n=await fetch(`${e}/oauth/v1/generate?grant_type=client_credentials`,{method:"GET",headers:{Authorization:`Basic ${r}`}});if(!n.ok)throw Error(`OAuth request failed: ${n.status}`);return n.json()}async function p(){await c.$executeRawUnsafe(`
    CREATE TABLE IF NOT EXISTS mpesa_donations (
      id SERIAL PRIMARY KEY,
      amount NUMERIC,
      phone TEXT,
      account_reference TEXT,
      transaction_desc TEXT,
      merchant_request_id TEXT,
      checkout_request_id TEXT,
      response_code TEXT,
      response_description TEXT,
      provider_response JSONB,
      mpesa_transaction_id TEXT,
      status TEXT DEFAULT 'pending',
      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
    )
  `)}let d="force-dynamic";async function l(e){try{let{phone:t,amount:s,accountReference:r,transactionDesc:n}=await e.json().catch(()=>({}))||{};if(!t||!s)return i.NextResponse.json({error:"Missing phone or amount"},{status:400});let o=process.env.MPESA_ENV||"sandbox",a="production"===o?"https://api.safaricom.co.ke":"https://sandbox.safaricom.co.ke",d=process.env.MPESA_CONSUMER_KEY,l=process.env.MPESA_CONSUMER_SECRET,x=process.env.MPESA_SHORTCODE,E=process.env.MPESA_PASSKEY,T=process.env.MPESA_CALLBACK_URL||`${a}/`;if(!d||!l)return i.NextResponse.json({error:"MPESA consumer credentials not configured"},{status:500});if("sandbox"!==o||x&&E&&"247247"!==x||(console.warn("Using sandbox shortcode/passkey fallback for STK testing"),x="174379",E="bfb279f9aa9bdbcf1xxxxxxxxxxxxxxxxxxxxxxxxxxxx"),!x||!E)return i.NextResponse.json({error:"MPESA shortcode or passkey not configured (and no sandbox fallback available)"},{status:500});await p();let h=await c.$queryRawUnsafe("INSERT INTO mpesa_donations (amount, phone, account_reference, transaction_desc, status, created_at, updated_at) VALUES ($1,$2,$3,$4,'pending',NOW(),NOW()) RETURNING id",s,t,r||null,n||null),m=h?.[0]?.id||null,f=await u(a,d,l),_=f?.access_token;if(!_)return i.NextResponse.json({error:"Failed to retrieve access token"},{status:500});let S=function(e=new Date){let t=e=>String(e).padStart(2,"0");return e.getFullYear().toString()+t(e.getMonth()+1)+t(e.getDate())+t(e.getHours())+t(e.getMinutes())+t(e.getSeconds())}(),R=Buffer.from(`${x}${E}${S}`).toString("base64"),g={BusinessShortCode:x,Password:R,Timestamp:S,TransactionType:"CustomerPayBillOnline",Amount:s,PartyA:t,PartyB:x,PhoneNumber:t,CallBackURL:T,AccountReference:r||String(t),TransactionDesc:n||"Donation"},A=await fetch(`${a}/mpesa/stkpush/v1/processrequest`,{method:"POST",headers:{Authorization:`Bearer ${_}`,"Content-Type":"application/json"},body:JSON.stringify(g)}),w=await A.json().catch(()=>({}));try{await c.$executeRawUnsafe("UPDATE mpesa_donations SET merchant_request_id=$1, checkout_request_id=$2, response_code=$3, response_description=$4, provider_response=$5::jsonb, updated_at=NOW() WHERE id=$6",w?.MerchantRequestID||w?.merchantRequestID||null,w?.CheckoutRequestID||w?.checkoutRequestID||null,w?.ResponseCode||w?.responseCode||null,w?.ResponseDescription||w?.responseDescription||null,JSON.stringify(w||{}),m)}catch(e){console.warn("Failed to update mpesa_donations with provider response",e)}return i.NextResponse.json({localId:m,provider:w},{status:A.ok?200:502})}catch(e){return console.error("STK Push error",e?.message||e),i.NextResponse.json({error:e?.message||"Server error"},{status:500})}}let x=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/mpesa/stk/route",pathname:"/api/mpesa/stk",filename:"route",bundlePath:"app/api/mpesa/stk/route"},resolvedPagePath:"/home/lod/Downloads/jwrc/app/api/mpesa/stk/route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:E,workUnitAsyncStorage:T,serverHooks:h}=x;function m(){return(0,a.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:T})}},62290:()=>{},51674:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[5089,9862],()=>s(5489));module.exports=r})();