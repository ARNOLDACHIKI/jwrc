(()=>{var e={};e.id=1130,e.ids=[1130],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},11514:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>L,routeModule:()=>T,serverHooks:()=>O,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>S});var s={};r.r(s),r.d(s,{GET:()=>x,PATCH:()=>N,dynamic:()=>R});var n=r(62137),a=r(63654),i=r(48093),o=r(63e3),u=r(96330),p=r(77136),l=r.n(p);let c=new u.PrismaClient;function d(e){let t=(e.headers.get("cookie")||"").split(";").map(e=>e.trim()).find(e=>e.startsWith("token="));return t?t.split("=")[1]:null}async function E(){await c.$executeRawUnsafe(`
    CREATE TABLE IF NOT EXISTS inbox_seen (
      user_id TEXT PRIMARY KEY,
      last_seen TIMESTAMP WITH TIME ZONE
    )
  `)}let R="force-dynamic";async function x(e){try{let t=d(e),r=process.env.JWT_SECRET||"dev-secret";if(!t)return o.NextResponse.json({lastSeen:null,unreadCount:0});let s=null;try{s=l().verify(t,r)}catch(e){return o.NextResponse.json({lastSeen:null,unreadCount:0})}let n=s.userId,a=s.email;await E();let i=await c.$queryRawUnsafe("SELECT last_seen FROM inbox_seen WHERE user_id = $1",String(n)),u=i&&i.length>0?i[0].last_seen:null,p=0;if(u){let e=await c.$queryRawUnsafe("SELECT COUNT(*) as c FROM suggestions WHERE LOWER(email)=LOWER($1) AND ((responded_at IS NOT NULL AND responded_at > $2::timestamptz) OR (responded_at IS NULL AND created_at > $2::timestamptz))",String(a),String(u)),t=await c.$queryRawUnsafe("SELECT COUNT(*) as c FROM volunteer_applications WHERE LOWER(email)=LOWER($1) AND ((responded_at IS NOT NULL AND responded_at > $2::timestamptz) OR (responded_at IS NULL AND created_at > $2::timestamptz))",String(a),String(u));p=(e[0]?.c||0)+(t[0]?.c||0)}else{let e=await c.$queryRawUnsafe("SELECT COUNT(*) as c FROM suggestions WHERE LOWER(email)=LOWER($1) AND admin_response IS NOT NULL",String(a)),t=await c.$queryRawUnsafe("SELECT COUNT(*) as c FROM volunteer_applications WHERE LOWER(email)=LOWER($1) AND admin_message IS NOT NULL",String(a));p=(e[0]?.c||0)+(t[0]?.c||0)}return o.NextResponse.json({lastSeen:u||null,unreadCount:Number(p)})}catch(e){return console.error(e),o.NextResponse.json({lastSeen:null,unreadCount:0})}}async function N(e){try{let t=d(e),r=process.env.JWT_SECRET||"dev-secret";if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let s=null;try{s=l().verify(t,r)}catch(e){return o.NextResponse.json({error:"Unauthorized"},{status:401})}let n=s.userId;return await E(),await c.$executeRawUnsafe("INSERT INTO inbox_seen (user_id, last_seen) VALUES ($1, NOW()) ON CONFLICT (user_id) DO UPDATE SET last_seen = NOW()",String(n)),o.NextResponse.json({ok:!0})}catch(e){return console.error(e),o.NextResponse.json({error:"Server error"},{status:500})}}let T=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/user/inbox/route",pathname:"/api/user/inbox",filename:"route",bundlePath:"app/api/user/inbox/route"},resolvedPagePath:"/home/lod/Downloads/jwrc/app/api/user/inbox/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:m,workUnitAsyncStorage:S,serverHooks:O}=T;function L(){return(0,i.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:S})}},62290:()=>{},51674:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[5089,9862,7136],()=>r(11514));module.exports=s})();