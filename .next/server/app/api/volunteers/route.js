"use strict";(()=>{var e={};e.id=7919,e.ids=[7919],e.modules={96330:e=>{e.exports=require("@prisma/client")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{e.exports=require("buffer")},79646:e=>{e.exports=require("child_process")},55511:e=>{e.exports=require("crypto")},14985:e=>{e.exports=require("dns")},94735:e=>{e.exports=require("events")},29021:e=>{e.exports=require("fs")},81630:e=>{e.exports=require("http")},55591:e=>{e.exports=require("https")},91645:e=>{e.exports=require("net")},21820:e=>{e.exports=require("os")},33873:e=>{e.exports=require("path")},27910:e=>{e.exports=require("stream")},34631:e=>{e.exports=require("tls")},79551:e=>{e.exports=require("url")},28354:e=>{e.exports=require("util")},74075:e=>{e.exports=require("zlib")},69643:(e,r,t)=>{t.r(r),t.d(r,{patchFetch:()=>h,routeModule:()=>_,serverHooks:()=>g,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>w});var s={};t.r(s),t.d(s,{GET:()=>v,PATCH:()=>S,POST:()=>R,dynamic:()=>x});var a=t(62137),n=t(63654),o=t(48093),i=t(63e3),l=t(96330),u=t(55511),p=t(77136),d=t.n(p),c=t(4873);let T=new l.PrismaClient;async function m(){await T.$executeRawUnsafe(`
    CREATE TABLE IF NOT EXISTS volunteer_applications (
      id TEXT PRIMARY KEY,
      name TEXT NOT NULL,
      email TEXT NOT NULL,
      phone TEXT,
      role_id TEXT,
      role_title TEXT,
      status TEXT DEFAULT 'pending',
      admin_message TEXT,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
      responded_at TIMESTAMP WITH TIME ZONE
    )
  `),await T.$executeRawUnsafe("ALTER TABLE volunteer_applications ADD COLUMN IF NOT EXISTS admin_message TEXT")}function E(e){let r=(e.headers.get("cookie")||"").split(";").map(e=>e.trim()).find(e=>e.startsWith("token="));return r?r.split("=")[1]:null}let x="force-dynamic";async function R(e){try{let{name:r,email:s,phone:a,roleId:n,roleTitle:o}=await e.json()||{},l={};if(r||(l.name="Name is required"),s||(l.email="Email is required"),n||o||(l.role="Role is required"),Object.keys(l).length)return i.NextResponse.json({errors:l},{status:400});await m();let p=(0,u.randomUUID)();await T.$executeRawUnsafe("INSERT INTO volunteer_applications (id, name, email, phone, role_id, role_title, status, created_at) VALUES ($1,$2,$3,$4,$5,$6,'pending',NOW())",p,String(r),String(s),a?String(a):null,n?String(n):null,o?String(o):null);try{if(process.env.SMTP_HOST&&process.env.SMTP_USER)try{let e=(await t.e(3040).then(t.t.bind(t,83040,19))).createTransport({host:process.env.SMTP_HOST,port:Number(process.env.SMTP_PORT||587),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}}),a=(0,c.oY)(String(r),o?String(o):n?String(n):"Volunteer Position");await e.sendMail({from:process.env.SMTP_FROM||process.env.SMTP_USER,to:String(s),subject:a.subject,html:a.html,text:a.text})}catch(e){console.warn("Failed to send confirmation email",e)}}catch(e){console.warn("Email send skipped",e)}return i.NextResponse.json({application:{id:p,name:r,email:s,phone:a,roleId:n,roleTitle:o,status:"pending"}},{status:201})}catch(e){return console.error(e),i.NextResponse.json({error:"Server error"},{status:500})}}async function v(e){try{let r=new URL(e.url),t=r.searchParams.get("email"),s=r.searchParams.get("summary");if(await m(),"roles"===s){let e=await T.$queryRawUnsafe('SELECT role_id as "roleId", role_title as "roleTitle", status, COUNT(*)::int as count FROM volunteer_applications GROUP BY role_id, role_title, status'),r={};for(let t of e){let e=`${t.roleId??""}|${t.roleTitle??""}`;r[e]||(r[e]={roleId:t.roleId||null,roleTitle:t.roleTitle||null,total:0,approved:0,pending:0,rejected:0});let s=r[e],a="number"==typeof t.count?t.count:Number(t.count||0);s.total+=a,"approved"===t.status?s.approved+=a:"pending"===t.status?s.pending+=a:"rejected"===t.status&&(s.rejected+=a)}return i.NextResponse.json({roles:Object.values(r)})}if(t){let e=await T.$queryRawUnsafe('SELECT id, name, email, phone, role_id as "roleId", role_title as "roleTitle", status, admin_message as "adminMessage", created_at as "createdAt", responded_at as "respondedAt" FROM volunteer_applications WHERE lower(email) = lower($1) ORDER BY created_at DESC',t);return i.NextResponse.json({applications:e})}let a=E(e),n=process.env.JWT_SECRET||"dev-secret";if(!a)return i.NextResponse.json({error:"Unauthorized"},{status:401});let o=null;try{o=d().verify(a,n)}catch(e){return i.NextResponse.json({error:"Unauthorized"},{status:401})}if("admin"!==o.role)return i.NextResponse.json({error:"Forbidden"},{status:403});let l=await T.$queryRawUnsafe('SELECT id, name, email, phone, role_id as "roleId", role_title as "roleTitle", status, admin_message as "adminMessage", created_at as "createdAt", responded_at as "respondedAt" FROM volunteer_applications ORDER BY created_at DESC');return i.NextResponse.json({applications:l})}catch(e){return console.error(e),i.NextResponse.json({error:"Server error"},{status:500})}}async function S(e){try{let r=E(e),t=process.env.JWT_SECRET||"dev-secret";if(!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let s=null;try{s=d().verify(r,t)}catch(e){return i.NextResponse.json({error:"Unauthorized"},{status:401})}if("admin"!==s.role)return i.NextResponse.json({error:"Forbidden"},{status:403});let{id:a,action:n,message:o}=await e.json()||{};if(!a||!n)return i.NextResponse.json({error:"Missing id or action"},{status:400});if(!["approve","reject"].includes(n))return i.NextResponse.json({error:"Invalid action"},{status:400});await m();let l=await T.$queryRawUnsafe("SELECT email FROM volunteer_applications WHERE id = $1",a),u=l&&l[0]?l[0].email:null,p="approve"===n?"approved":"rejected";if(await T.$executeRawUnsafe("UPDATE volunteer_applications SET status = $1, admin_message = $2, responded_at = NOW() WHERE id = $3",p,o?String(o):null,a),u)try{await T.user.updateMany({where:{email:{equals:String(u),mode:"insensitive"}},data:{isVolunteer:"approved"===p}})}catch(e){console.warn("Failed to sync volunteer flag to user",e)}return i.NextResponse.json({ok:!0})}catch(e){return console.error(e),i.NextResponse.json({error:"Server error"},{status:500})}}let _=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/volunteers/route",pathname:"/api/volunteers",filename:"route",bundlePath:"app/api/volunteers/route"},resolvedPagePath:"/home/lod/Downloads/jwrc/app/api/volunteers/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:w,serverHooks:g}=_;function h(){return(0,o.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:w})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[5089,9862,7136,9289],()=>t(69643));module.exports=s})();