"use strict";(()=>{var e={};e.id=7593,e.ids=[7593],e.modules={96330:e=>{e.exports=require("@prisma/client")},10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{e.exports=require("buffer")},79646:e=>{e.exports=require("child_process")},55511:e=>{e.exports=require("crypto")},14985:e=>{e.exports=require("dns")},94735:e=>{e.exports=require("events")},29021:e=>{e.exports=require("fs")},81630:e=>{e.exports=require("http")},55591:e=>{e.exports=require("https")},91645:e=>{e.exports=require("net")},21820:e=>{e.exports=require("os")},33873:e=>{e.exports=require("path")},27910:e=>{e.exports=require("stream")},34631:e=>{e.exports=require("tls")},79551:e=>{e.exports=require("url")},28354:e=>{e.exports=require("util")},74075:e=>{e.exports=require("zlib")},70693:(e,r,s)=>{s.r(r),s.d(r,{patchFetch:()=>M,routeModule:()=>h,serverHooks:()=>_,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>w});var t={};s.r(t),s.d(t,{GET:()=>R,PATCH:()=>x,POST:()=>E,dynamic:()=>T});var n=s(62137),o=s(63654),a=s(48093),i=s(63e3),p=s(96330),u=s(55511),d=s(77136),c=s.n(d),l=s(4873);let m=new p.PrismaClient;async function g(){await m.$executeRawUnsafe(`
    CREATE TABLE IF NOT EXISTS suggestions (
      id TEXT PRIMARY KEY,
      name TEXT,
      email TEXT,
      type TEXT,
      message TEXT,
      admin_response TEXT,
      responder_name TEXT,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
      responded_at TIMESTAMP WITH TIME ZONE
    )
  `)}function S(e){let r=(e.headers.get("cookie")||"").split(";").map(e=>e.trim()).find(e=>e.startsWith("token="));return r?r.split("=")[1]:null}let T="force-dynamic";async function E(e){try{let{name:r,email:t,type:n,message:o}=await e.json()||{},a={};if(t||(a.email="Email is required"),o||(a.message="Message is required"),Object.keys(a).length)return i.NextResponse.json({errors:a},{status:400});await g();let p=(0,u.randomUUID)();await m.$executeRawUnsafe("INSERT INTO suggestions (id, name, email, type, message, created_at) VALUES ($1,$2,$3,$4,$5,NOW())",p,r?String(r):null,String(t),n?String(n):"suggestion",String(o));try{if(process.env.SMTP_HOST&&process.env.SMTP_USER)try{let e=(await s.e(3040).then(s.t.bind(s,83040,19))).createTransport({host:process.env.SMTP_HOST,port:Number(process.env.SMTP_PORT||587),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}}),o=(0,l.e1)(r?String(r):"",n?String(n):"suggestion");await e.sendMail({from:process.env.SMTP_FROM||process.env.SMTP_USER,to:String(t),subject:o.subject,html:o.html,text:o.text})}catch(e){console.warn("Failed to send confirmation email",e)}}catch(e){console.warn("Email send skipped",e)}return i.NextResponse.json({suggestion:{id:p,name:r,email:t,type:n,message:o}},{status:201})}catch(e){return console.error(e),i.NextResponse.json({error:"Server error"},{status:500})}}async function R(e){try{let r=new URL(e.url).searchParams.get("email");if(await g(),r){let e=await m.$queryRawUnsafe('SELECT id, name, email, type, message, admin_response as "adminResponse", responder_name as "responderName", created_at as "createdAt", responded_at as "respondedAt" FROM suggestions WHERE LOWER(email) = LOWER($1) ORDER BY created_at DESC',String(r));return i.NextResponse.json({suggestions:e})}let s=S(e);if(!s){let r=e.headers.get("authorization")||e.headers.get("Authorization");r&&r.toLowerCase().startsWith("bearer ")&&(s=r.split(" ")[1])}let t=process.env.JWT_SECRET||"dev-secret";if(!s)return i.NextResponse.json({error:"Unauthorized"},{status:401});let n=null;try{n=c().verify(s,t)}catch(e){return i.NextResponse.json({error:"Unauthorized"},{status:401})}let o=process.env.ADMIN_EMAIL||"";if("admin"!==n.role&&String(n.email||"").toLowerCase()!==o.toLowerCase())return i.NextResponse.json({error:"Forbidden"},{status:403});let a=await m.$queryRawUnsafe('SELECT id, name, email, type, message, admin_response as "adminResponse", responder_name as "responderName", created_at as "createdAt", responded_at as "respondedAt" FROM suggestions ORDER BY created_at DESC');return i.NextResponse.json({suggestions:a})}catch(e){return console.error(e),i.NextResponse.json({error:"Server error"},{status:500})}}async function x(e){try{let r=S(e);if(!r){let s=e.headers.get("authorization")||e.headers.get("Authorization");s&&s.toLowerCase().startsWith("bearer ")&&(r=s.split(" ")[1])}let t=process.env.JWT_SECRET||"dev-secret";if(!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let n=null;try{n=c().verify(r,t)}catch(e){return i.NextResponse.json({error:"Unauthorized"},{status:401})}let o=process.env.ADMIN_EMAIL||"";if("admin"!==n.role&&String(n.email||"").toLowerCase()!==o.toLowerCase())return i.NextResponse.json({error:"Forbidden"},{status:403});let{id:a,response:p,responderName:u}=await e.json()||{};if(!a||!p)return i.NextResponse.json({error:"Missing id or response"},{status:400});await g();let d=u||n.email||n.name||"admin",l=await m.$queryRawUnsafe("SELECT id, name, email, type FROM suggestions WHERE id = $1 LIMIT 1",String(a)),T=l&&l[0]?l[0]:null;if(await m.$executeRawUnsafe("UPDATE suggestions SET admin_response = $1, responder_name = $3, responded_at = NOW() WHERE id = $2",String(p),a,String(d)),T&&T.email)try{if(process.env.SMTP_HOST&&process.env.SMTP_USER){let e=(await s.e(3040).then(s.t.bind(s,83040,19))).createTransport({host:process.env.SMTP_HOST,port:Number(process.env.SMTP_PORT||587),secure:"true"===process.env.SMTP_SECURE,auth:{user:process.env.SMTP_USER,pass:process.env.SMTP_PASS}}),{getSuggestionResponseEmail:r}=await Promise.resolve().then(s.bind(s,4873)),t=r(T.name||T.email||"",String(p),d,T.type||"suggestion");await e.sendMail({from:process.env.SMTP_FROM||process.env.SMTP_USER,to:String(T.email),subject:t.subject,html:t.html,text:t.text})}}catch(e){console.warn("Failed to send suggestion response email",e)}return i.NextResponse.json({ok:!0})}catch(e){return console.error(e),i.NextResponse.json({error:"Server error"},{status:500})}}let h=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/suggestions/route",pathname:"/api/suggestions",filename:"route",bundlePath:"app/api/suggestions/route"},resolvedPagePath:"/home/lod/Downloads/jwrc/app/api/suggestions/route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:v,workUnitAsyncStorage:w,serverHooks:_}=h;function M(){return(0,a.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:w})}}};var r=require("../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[5089,9862,7136,9289],()=>s(70693));module.exports=t})();