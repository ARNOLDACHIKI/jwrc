module.exports=[70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},60401,e=>{"use strict";var t=e.i(61944),r=e.i(67168),a=e.i(54557),n=e.i(27507),s=e.i(57713),o=e.i(45926),i=e.i(77673),l=e.i(13479),d=e.i(84380),p=e.i(67986),u=e.i(95353),c=e.i(71179),E=e.i(57811),R=e.i(3400),T=e.i(80489),m=e.i(33750),h=e.i(93695);e.i(99110);var v=e.i(74517),x=e.i(16153);let f=new(e.i(29173)).PrismaClient;async function _(e,t,r){let a=Buffer.from(`${t}:${r}`).toString("base64"),n=await fetch(`${e}/oauth/v1/generate?grant_type=client_credentials`,{method:"GET",headers:{Authorization:`Basic ${a}`}});if(!n.ok)throw Error(`OAuth request failed: ${n.status}`);return n.json()}async function y(){await f.$executeRawUnsafe(`
    CREATE TABLE IF NOT EXISTS mpesa_b2b_payments (
      id SERIAL PRIMARY KEY,
      amount NUMERIC,
      party_a TEXT,
      party_b TEXT,
      account_reference TEXT,
      initiator TEXT,
      requester TEXT,
      remarks TEXT,
      provider_response JSONB,
      originator_conversation_id TEXT,
      conversation_id TEXT,
      response_code TEXT,
      response_description TEXT,
      transaction_id TEXT,
      status TEXT DEFAULT 'pending',
      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
    )
  `)}async function g(e){try{let{Initiator:t,SecurityCredential:r,CommandID:a,SenderIdentifierType:n,ReceiverIdentifierType:s,Amount:o,PartyA:i,PartyB:l,AccountReference:d,Requester:p,Remarks:u,QueueTimeOutURL:c,ResultURL:E,Occasion:R}=await e.json().catch(()=>({}))||{};if(!o||!i||!l)return x.NextResponse.json({error:"Missing required fields: Amount, PartyA, PartyB"},{status:400});let T=process.env.MPESA_ENV||"sandbox",m="production"===T?"https://api.safaricom.co.ke":"https://sandbox.safaricom.co.ke",h=process.env.MPESA_CONSUMER_KEY,v=process.env.MPESA_CONSUMER_SECRET;if(!h||!v)return x.NextResponse.json({error:"MPESA consumer credentials not configured"},{status:500});let g=t||process.env.MPESA_INITIATOR||"",A=r||process.env.MPESA_SECURITY_CREDENTIAL||"";if(!g||!A)return x.NextResponse.json({error:"Initiator or SecurityCredential not provided (or MPESA_INITIATOR/MPESA_SECURITY_CREDENTIAL missing)"},{status:500});await y();let w=await f.$queryRawUnsafe("INSERT INTO mpesa_b2b_payments (amount, party_a, party_b, account_reference, initiator, requester, remarks, status, created_at, updated_at) VALUES ($1,$2,$3,$4,$5,$6,$7,'pending',NOW(),NOW()) RETURNING id",o,i,l,d||null,g,p||null,u||null),S=w?.[0]?.id||null,b=await _(m,h,v),C=b?.access_token;if(!C)return x.NextResponse.json({error:"Failed to retrieve access token"},{status:500});let N={Initiator:g,SecurityCredential:A,CommandID:a||"BusinessPayBill",SenderIdentifierType:n||"4",ReceiverIdentifierType:s||"4",Amount:o,PartyA:i,PartyB:l,AccountReference:d||String(i),Remarks:u||"Business to Business payment",QueueTimeOutURL:c||process.env.MPESA_B2B_QUEUE_TIMEOUT_URL||`${m}/mpesa/callback`,ResultURL:E||process.env.MPESA_B2B_RESULT_URL||`${m}/mpesa/callback`};p&&(N.Requester=p),R&&(N.Occasion=R);let I=await fetch(`${m}/mpesa/b2b/v1/paymentrequest`,{method:"POST",headers:{Authorization:`Bearer ${C}`,"Content-Type":"application/json"},body:JSON.stringify(N)}),P=await I.json().catch(()=>({}));try{await f.$executeRawUnsafe("UPDATE mpesa_b2b_payments SET provider_response=$1::jsonb, originator_conversation_id=$2, conversation_id=$3, response_code=$4, response_description=$5, updated_at=NOW() WHERE id=$6",JSON.stringify(P||{}),P?.OriginatorConversationID||P?.originatorConversationID||null,P?.ConversationID||P?.conversationID||null,P?.ResponseCode||P?.responseCode||null,P?.ResponseDescription||P?.responseDescription||null,S)}catch(e){console.warn("Failed to update mpesa_b2b_payments with provider response",e)}return x.NextResponse.json({localId:S,provider:P},{status:I.ok?200:502})}catch(e){return console.error("B2B payment error",e?.message||e),x.NextResponse.json({error:e?.message||"Server error"},{status:500})}}e.s(["POST",()=>g,"dynamic",0,"force-dynamic"],39853);var A=e.i(39853);let w=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/mpesa/b2b/route",pathname:"/api/mpesa/b2b",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/jwrc/app/api/mpesa/b2b/route.ts",nextConfigOutput:"",userland:A}),{workAsyncStorage:S,workUnitAsyncStorage:b,serverHooks:C}=w;function N(){return(0,a.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:b})}async function I(e,t,a){w.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/mpesa/b2b/route";x=x.replace(/\/index$/,"")||"/";let f=await w.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:_,params:y,nextConfig:g,parsedUrl:A,isDraftMode:S,prerenderManifest:b,routerServerContext:C,isOnDemandRevalidate:N,revalidateOnlyGenerated:I,resolvedPathname:P,clientReferenceManifest:O,serverActionsManifest:M}=f,U=(0,l.normalizeAppPath)(x),$=!!(b.dynamicRoutes[U]||b.routes[P]),k=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,A,!1):t.end("This page could not be found"),null);if($&&!S){let e=!!b.routes[P],t=b.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(g.experimental.adapterPath)return await k();throw new h.NoFallbackError}}let j=null;!$||w.isDev||S||(j="/index"===(j=P)?"/":j);let q=!0===w.isDev||!$,D=$&&!q;M&&O&&(0,o.setReferenceManifestsSingleton)({page:x,clientReferenceManifest:O,serverActionsManifest:M,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:M})});let B=e.method||"GET",H=(0,s.getTracer)(),L=H.getActiveScopeSpan(),X={params:y,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!g.experimental.authInterrupts},cacheComponents:!!g.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:g.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>w.onRequestError(e,t,a,C)},sharedContext:{buildId:_}},F=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),W=p.NextRequestAdapter.fromNodeNextRequest(F,(0,p.signalFromNodeResponse)(t));try{let o=async e=>w.handle(W,X).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${B} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${x}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!i&&N&&I&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(n);e.fetchMetrics=X.renderOpts.fetchMetrics;let l=X.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=X.renderOpts.collectedTags;if(!$)return await (0,E.sendResponse)(F,K,s,X.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==X.renderOpts.collectedRevalidate&&!(X.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&X.renderOpts.collectedRevalidate,a=void 0===X.renderOpts.collectedExpire||X.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:X.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await w.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:N})},C),t}},p=await w.handleResponse({req:e,nextConfig:g,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:I,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:i});if(!$)return null;if((null==p||null==(s=p.value)?void 0:s.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",N?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,R.fromNodeOutgoingHttpHeaders)(p.value.headers);return i&&$||u.delete(m.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,T.getCacheControlHeader)(p.cacheControl)),await (0,E.sendResponse)(F,K,new Response(p.value.body,{headers:u,status:p.value.status||200})),null};L?await l(L):await H.withPropagatedContext(e.headers,()=>H.trace(u.BaseServerSpan.handleRequest,{spanName:`${B} ${x}`,kind:s.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await w.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:N})}),$)throw t;return await (0,E.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>N,"routeModule",()=>w,"serverHooks",()=>C,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>b],60401)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__cc49f6bf._.js.map