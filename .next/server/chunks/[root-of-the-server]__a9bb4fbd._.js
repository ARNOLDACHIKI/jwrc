module.exports=[70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},60339,(e,t,r)=>{t.exports=e.x("@prisma/client-645c496f28619def",()=>require("@prisma/client-645c496f28619def"))},55912,e=>{"use strict";var t=e.i(51004),r=e.i(32070),a=e.i(839),n=e.i(11444),s=e.i(29214),o=e.i(40457),i=e.i(89575),l=e.i(55350),d=e.i(52117),p=e.i(93183),u=e.i(81124),c=e.i(24294),E=e.i(68345),R=e.i(1742),T=e.i(49174),m=e.i(93695);e.i(50821);var h=e.i(31158),v=e.i(40295);let f=new(e.i(60339)).PrismaClient;async function x(e,t,r){let a=Buffer.from(`${t}:${r}`).toString("base64"),n=await fetch(`${e}/oauth/v1/generate?grant_type=client_credentials`,{method:"GET",headers:{Authorization:`Basic ${a}`}});if(!n.ok)throw Error(`OAuth request failed: ${n.status}`);return n.json()}async function _(){await f.$executeRawUnsafe(`
    CREATE TABLE IF NOT EXISTS mpesa_b2b_payments (
      id SERIAL PRIMARY KEY,
      amount NUMERIC,
      party_a TEXT,
      party_b TEXT,
      account_reference TEXT,
      initiator TEXT,
      requester TEXT,
      remarks TEXT,
      provider_response JSONB,
      originator_conversation_id TEXT,
      conversation_id TEXT,
      response_code TEXT,
      response_description TEXT,
      transaction_id TEXT,
      status TEXT DEFAULT 'pending',
      created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
    )
  `)}async function y(e){try{let{Initiator:t,SecurityCredential:r,CommandID:a,SenderIdentifierType:n,ReceiverIdentifierType:s,Amount:o,PartyA:i,PartyB:l,AccountReference:d,Requester:p,Remarks:u,QueueTimeOutURL:c,ResultURL:E,Occasion:R}=await e.json().catch(()=>({}))||{};if(!o||!i||!l)return v.NextResponse.json({error:"Missing required fields: Amount, PartyA, PartyB"},{status:400});let T=process.env.MPESA_ENV||"sandbox",m="production"===T?"https://api.safaricom.co.ke":"https://sandbox.safaricom.co.ke",h=process.env.MPESA_CONSUMER_KEY,y=process.env.MPESA_CONSUMER_SECRET;if(!h||!y)return v.NextResponse.json({error:"MPESA consumer credentials not configured"},{status:500});let g=t||process.env.MPESA_INITIATOR||"",A=r||process.env.MPESA_SECURITY_CREDENTIAL||"";if(!g||!A)return v.NextResponse.json({error:"Initiator or SecurityCredential not provided (or MPESA_INITIATOR/MPESA_SECURITY_CREDENTIAL missing)"},{status:500});await _();let w=await f.$queryRawUnsafe("INSERT INTO mpesa_b2b_payments (amount, party_a, party_b, account_reference, initiator, requester, remarks, status, created_at, updated_at) VALUES ($1,$2,$3,$4,$5,$6,$7,'pending',NOW(),NOW()) RETURNING id",o,i,l,d||null,g,p||null,u||null),b=w?.[0]?.id||null,C=await x(m,h,y),S=C?.access_token;if(!S)return v.NextResponse.json({error:"Failed to retrieve access token"},{status:500});let N={Initiator:g,SecurityCredential:A,CommandID:a||"BusinessPayBill",SenderIdentifierType:n||"4",ReceiverIdentifierType:s||"4",Amount:o,PartyA:i,PartyB:l,AccountReference:d||String(i),Remarks:u||"Business to Business payment",QueueTimeOutURL:c||process.env.MPESA_B2B_QUEUE_TIMEOUT_URL||`${m}/mpesa/callback`,ResultURL:E||process.env.MPESA_B2B_RESULT_URL||`${m}/mpesa/callback`};p&&(N.Requester=p),R&&(N.Occasion=R);let I=await fetch(`${m}/mpesa/b2b/v1/paymentrequest`,{method:"POST",headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json"},body:JSON.stringify(N)}),P=await I.json().catch(()=>({}));try{await f.$executeRawUnsafe("UPDATE mpesa_b2b_payments SET provider_response=$1::jsonb, originator_conversation_id=$2, conversation_id=$3, response_code=$4, response_description=$5, updated_at=NOW() WHERE id=$6",JSON.stringify(P||{}),P?.OriginatorConversationID||P?.originatorConversationID||null,P?.ConversationID||P?.conversationID||null,P?.ResponseCode||P?.responseCode||null,P?.ResponseDescription||P?.responseDescription||null,b)}catch(e){console.warn("Failed to update mpesa_b2b_payments with provider response",e)}return v.NextResponse.json({localId:b,provider:P},{status:I.ok?200:502})}catch(e){return console.error("B2B payment error",e?.message||e),v.NextResponse.json({error:e?.message||"Server error"},{status:500})}}e.s(["POST",()=>y,"dynamic",0,"force-dynamic"],39853);var g=e.i(39853);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/mpesa/b2b/route",pathname:"/api/mpesa/b2b",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/jwrc/app/api/mpesa/b2b/route.ts",nextConfigOutput:"",userland:g}),{workAsyncStorage:w,workUnitAsyncStorage:b,serverHooks:C}=A;function S(){return(0,a.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:b})}async function N(e,t,a){A.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/mpesa/b2b/route";v=v.replace(/\/index$/,"")||"/";let f=await A.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:x,params:_,nextConfig:y,parsedUrl:g,isDraftMode:w,prerenderManifest:b,routerServerContext:C,isOnDemandRevalidate:S,revalidateOnlyGenerated:N,resolvedPathname:I,clientReferenceManifest:P,serverActionsManifest:O}=f,U=(0,i.normalizeAppPath)(v),M=!!(b.dynamicRoutes[U]||b.routes[I]),$=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,g,!1):t.end("This page could not be found"),null);if(M&&!w){let e=!!b.routes[I],t=b.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await $();throw new m.NoFallbackError}}let k=null;!M||A.isDev||w||(k="/index"===(k=I)?"/":k);let j=!0===A.isDev||!M,q=M&&!j;O&&P&&(0,o.setManifestsSingleton)({page:v,clientReferenceManifest:P,serverActionsManifest:O});let D=e.method||"GET",B=(0,s.getTracer)(),H=B.getActiveScopeSpan(),L={params:_,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>A.onRequestError(e,t,a,n,C)},sharedContext:{buildId:x}},X=new l.NodeNextRequest(e),F=new l.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest(X,(0,d.signalFromNodeResponse)(t));try{let o=async e=>A.handle(K,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${D} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${v}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let d=async({previousCacheEntry:r})=>{try{if(!i&&S&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(n);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!M)return await (0,c.sendResponse)(X,F,s,L.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[T.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=T.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=T.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:S})},!1,C),t}},p=await A.handleResponse({req:e,nextConfig:y,cacheKey:k,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:i});if(!M)return null;if((null==p||null==(s=p.value)?void 0:s.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(l=p.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",S?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),w&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,E.fromNodeOutgoingHttpHeaders)(p.value.headers);return i&&M||m.delete(T.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,R.getCacheControlHeader)(p.cacheControl)),await (0,c.sendResponse)(X,F,new Response(p.value.body,{headers:m,status:p.value.status||200})),null};H?await l(H):await B.withPropagatedContext(e.headers,()=>B.trace(p.BaseServerSpan.handleRequest,{spanName:`${D} ${v}`,kind:s.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:S})},!1,C),M)throw t;return await (0,c.sendResponse)(X,F,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>S,"routeModule",()=>A,"serverHooks",()=>C,"workAsyncStorage",()=>w,"workUnitAsyncStorage",()=>b],55912)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__a9bb4fbd._.js.map